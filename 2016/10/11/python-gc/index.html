<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/blog/atom.xml" title="Blog My Minds" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.0.1" />






<meta name="description" content="Python垃圾回收概述
Python中的垃圾回收机制基于引用计数(ob_refcnt)，因此需要解决循环引用导致引用计数不能归零的问题。例如
1234567891011121314151617# create[1]list1=[]              # dellist2=[list1]         # dellist1.append(list2)list3 = []">
<meta property="og:type" content="article">
<meta property="og:title" content="Python源码剖析—循环垃圾回收器">
<meta property="og:url" content="http://fanchao01.github.io/blog/2016/10/11/python-gc/index.html">
<meta property="og:site_name" content="Blog My Minds">
<meta property="og:description" content="Python垃圾回收概述
Python中的垃圾回收机制基于引用计数(ob_refcnt)，因此需要解决循环引用导致引用计数不能归零的问题。例如
1234567891011121314151617# create[1]list1=[]              # dellist2=[list1]         # dellist1.append(list2)list3 = []">
<meta property="og:image" content="http://fanchao01.github.io/blog/blog/images/python-gcmodule.jpg">
<meta property="og:updated_time" content="2016-10-25T12:37:00.635Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python源码剖析—循环垃圾回收器">
<meta name="twitter:description" content="Python垃圾回收概述
Python中的垃圾回收机制基于引用计数(ob_refcnt)，因此需要解决循环引用导致引用计数不能归零的问题。例如
1234567891011121314151617# create[1]list1=[]              # dellist2=[list1]         # dellist1.append(list2)list3 = []">
<meta name="twitter:image" content="http://fanchao01.github.io/blog/blog/images/python-gcmodule.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Python源码剖析—循环垃圾回收器 | Blog My Minds </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?7f592ce66e56bd7572224ba7c19a8f40";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Blog My Minds</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Python源码剖析—循环垃圾回收器
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-11T00:00:00-07:00" content="2016-10-11">
              2016-10-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/blog/categories/python源码剖析/" itemprop="url" rel="index">
                    <span itemprop="name">python源码剖析</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/blog/2016/10/11/python-gc/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/11/python-gc/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Python垃圾回收概述"><a href="#Python垃圾回收概述" class="headerlink" title="Python垃圾回收概述"></a>Python垃圾回收概述</h2><hr>
<p>Python中的垃圾回收机制基于引用计数(ob_refcnt)，因此需要解决循环引用导致引用计数不能归零的问题。例如</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># create[1]</span></div><div class="line">list1=[]              <span class="comment"># del</span></div><div class="line">list2=[list1]         <span class="comment"># del</span></div><div class="line">list1.append(list2)</div><div class="line"></div><div class="line">list3 = []            <span class="comment"># del</span></div><div class="line">list4 = []</div><div class="line">list5 = [list3, list4] <span class="comment"># del</span></div><div class="line">list6 = [list3, list4]</div><div class="line">list3.append(list4)</div><div class="line"></div><div class="line"><span class="comment"># del[2]</span></div><div class="line"><span class="keyword">del</span> list1; <span class="keyword">del</span> list2;<span class="keyword">del</span> list3;<span class="keyword">del</span> list5 <span class="comment"># [2]</span></div><div class="line"><span class="comment"># list1.ob_refcnt == list2.ob_refcnt == 1</span></div><div class="line"></div><div class="line"><span class="comment"># collect[3]</span></div><div class="line">gc.collect()</div></pre></td></tr></table></figure>
<p>虽然<code>list1</code>与<code>list2</code>已经成为需要回收的垃圾，但是由于相互引用导致引用计数不能归零，从而不能触发自动回收。因此Python引入了<code>循环垃圾收集器</code>。</p>
<h2 id="循环垃圾收集器的原理"><a href="#循环垃圾收集器的原理" class="headerlink" title="循环垃圾收集器的原理"></a>循环垃圾收集器的原理</h2><hr>
<p>判断对象是否为垃圾的逻辑比较直白，有外部引用或者被有外部引用的对象引用的对象为非垃圾对象；否则为垃圾对象。具体过程为，遍历所有对象将对象中引用的元素(其他对象)的引用计数减一，最后引用计数不归零的对象(存在外部引用)不是垃圾对象；被不是垃圾对象引用的元素(其他对象)也不是垃圾对象；剩余的则为垃圾对象。可以归纳为如下步骤：</p>
<ol>
<li>创建可能存在循环应用的对象时，将该对象纳入链表进行管理</li>
<li>遍历所有纳入管理的对象，将对象引用的元素(其他对象)的引用计数减一</li>
<li><p>再次遍历:<br><1> 处理对象：对该对象进行标记<br>所有引用计数为零的对象没有外部引用，标记为可能是垃圾；<br>所有引用计数不为零的对象存在外部引用，必然不是垃圾。</1></p>
<p>|0   |可能是垃圾 |list1、list2、list3、list5|<br>|&gt;0  |不是垃圾   |list4、list6|</p>
<p><2> 处理对象：遍历不是垃圾对象中的元素，不是垃圾对象中的元素必然不是垃圾</2></p>
</li>
<li>最后没有被确定不是垃圾的对象就是垃圾对象</li>
</ol>
<p>这部分处理代码比较复杂，每个对象可能作为两种角色进行处理。作为代中的对象以及作为对象中的引用元素。如果作为元素被处理，则肯定不是垃圾。</p>
<p>各个阶段对象中的引用计数</p>
<p><img src="/blog/images/python-gcmodule.jpg" alt="image"></p>
<h2 id="垃圾对象不一定能被自动回收"><a href="#垃圾对象不一定能被自动回收" class="headerlink" title="垃圾对象不一定能被自动回收"></a>垃圾对象不一定能被自动回收</h2><hr>
<p>垃圾对象不一定能被自动回收。所以上面的步骤只能确定垃圾对象，然后对垃圾对象进行额外处理甄别不能回收和能被回收的部分。</p>
<ul>
<li>垃圾对象：没有外部引用的对象，也没有被有外部引用的对象引用</li>
<li>可回收对象：垃圾对象中能够被自动回收的对象</li>
<li>reachable：非垃圾对象，存在外部引用或者被外部引用的对象引用</li>
<li>unrechable: 垃圾对象</li>
<li>collectable: 可回收对象</li>
<li>finalizers: 垃圾对象中不能被自动回收的对象。一些对象存在析构函数并且相互引用，这样的对象Python不能自动确定回收顺序，因此不能被自动回收。</li>
</ul>
<h2 id="不是所有对象都纳入循环垃圾收集器"><a href="#不是所有对象都纳入循环垃圾收集器" class="headerlink" title="不是所有对象都纳入循环垃圾收集器"></a>不是所有对象都纳入循环垃圾收集器</h2><hr>
<p>一些基本对象不会产生循环引用，例如int、float、string等，所以没有必须使用循环垃圾收集器，基本的引用计数回收机制即可。还有一些容器类对象，他们中的元素都是基本元素不会引起循环引用，例如{‘a’:1}、(1, 2, 3)，因此也不纳入循环垃圾收集器。所以只有部分容器类对象、生成器、含<code>__del__</code>类等才纳入循环垃圾收集器。</p>
<h2 id="垃圾回收中的代"><a href="#垃圾回收中的代" class="headerlink" title="垃圾回收中的代"></a>垃圾回收中的代</h2><hr>
<p>如上分析，整个循环垃圾收集的效率严重依赖可能引起循环引用的对象的个数。为了减少垃圾回收的动作，Python将对象分代：存活越长的对象越不可能是垃圾，就减少对其进行垃圾回收的次数。那么<code>存活</code>的时间长短就用经过了几次垃圾回收来判断，于是刚创建的对象为一代，当经过一次垃圾回收还存活的对象放入二代；多次一代垃圾回收后，才进行一次二代垃圾回收。Python将整个对象分为三代，当分配足够数量的对象后(700)进行一次一代回收；当进行一定数量(10)一代回收后进行二代回收；同理进行三代回收。</p>
<h2 id="gcmodule-c源码分析"><a href="#gcmodule-c源码分析" class="headerlink" title="gcmodule.c源码分析"></a>gcmodule.c源码分析</h2><hr>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div><div class="line">631</div><div class="line">632</div><div class="line">633</div><div class="line">634</div><div class="line">635</div><div class="line">636</div><div class="line">637</div><div class="line">638</div><div class="line">639</div><div class="line">640</div><div class="line">641</div><div class="line">642</div><div class="line">643</div><div class="line">644</div><div class="line">645</div><div class="line">646</div><div class="line">647</div><div class="line">648</div><div class="line">649</div><div class="line">650</div><div class="line">651</div><div class="line">652</div><div class="line">653</div><div class="line">654</div><div class="line">655</div><div class="line">656</div><div class="line">657</div><div class="line">658</div><div class="line">659</div><div class="line">660</div><div class="line">661</div><div class="line">662</div><div class="line">663</div><div class="line">664</div><div class="line">665</div><div class="line">666</div><div class="line">667</div><div class="line">668</div><div class="line">669</div><div class="line">670</div><div class="line">671</div><div class="line">672</div><div class="line">673</div><div class="line">674</div><div class="line">675</div><div class="line">676</div><div class="line">677</div><div class="line">678</div><div class="line">679</div><div class="line">680</div><div class="line">681</div><div class="line">682</div><div class="line">683</div><div class="line">684</div><div class="line">685</div><div class="line">686</div><div class="line">687</div><div class="line">688</div><div class="line">689</div><div class="line">690</div><div class="line">691</div><div class="line">692</div><div class="line">693</div><div class="line">694</div><div class="line">695</div><div class="line">696</div><div class="line">697</div><div class="line">698</div><div class="line">699</div><div class="line">700</div><div class="line">701</div><div class="line">702</div><div class="line">703</div><div class="line">704</div><div class="line">705</div><div class="line">706</div><div class="line">707</div><div class="line">708</div><div class="line">709</div><div class="line">710</div><div class="line">711</div><div class="line">712</div><div class="line">713</div><div class="line">714</div><div class="line">715</div><div class="line">716</div><div class="line">717</div><div class="line">718</div><div class="line">719</div><div class="line">720</div><div class="line">721</div><div class="line">722</div><div class="line">723</div><div class="line">724</div><div class="line">725</div><div class="line">726</div><div class="line">727</div><div class="line">728</div><div class="line">729</div><div class="line">730</div><div class="line">731</div><div class="line">732</div><div class="line">733</div><div class="line">734</div><div class="line">735</div><div class="line">736</div><div class="line">737</div><div class="line">738</div><div class="line">739</div><div class="line">740</div><div class="line">741</div><div class="line">742</div><div class="line">743</div><div class="line">744</div><div class="line">745</div><div class="line">746</div><div class="line">747</div><div class="line">748</div><div class="line">749</div><div class="line">750</div><div class="line">751</div><div class="line">752</div><div class="line">753</div><div class="line">754</div><div class="line">755</div><div class="line">756</div><div class="line">757</div><div class="line">758</div><div class="line">759</div><div class="line">760</div><div class="line">761</div><div class="line">762</div><div class="line">763</div><div class="line">764</div><div class="line">765</div><div class="line">766</div><div class="line">767</div><div class="line">768</div><div class="line">769</div><div class="line">770</div><div class="line">771</div><div class="line">772</div><div class="line">773</div><div class="line">774</div><div class="line">775</div><div class="line">776</div><div class="line">777</div><div class="line">778</div><div class="line">779</div><div class="line">780</div><div class="line">781</div><div class="line">782</div><div class="line">783</div><div class="line">784</div><div class="line">785</div><div class="line">786</div><div class="line">787</div><div class="line">788</div><div class="line">789</div><div class="line">790</div><div class="line">791</div><div class="line">792</div><div class="line">793</div><div class="line">794</div><div class="line">795</div><div class="line">796</div><div class="line">797</div><div class="line">798</div><div class="line">799</div><div class="line">800</div><div class="line">801</div><div class="line">802</div><div class="line">803</div><div class="line">804</div><div class="line">805</div><div class="line">806</div><div class="line">807</div><div class="line">808</div><div class="line">809</div><div class="line">810</div><div class="line">811</div><div class="line">812</div><div class="line">813</div><div class="line">814</div><div class="line">815</div><div class="line">816</div><div class="line">817</div><div class="line">818</div><div class="line">819</div><div class="line">820</div><div class="line">821</div><div class="line">822</div><div class="line">823</div><div class="line">824</div><div class="line">825</div><div class="line">826</div><div class="line">827</div><div class="line">828</div><div class="line">829</div><div class="line">830</div><div class="line">831</div><div class="line">832</div><div class="line">833</div><div class="line">834</div><div class="line">835</div><div class="line">836</div><div class="line">837</div><div class="line">838</div><div class="line">839</div><div class="line">840</div><div class="line">841</div><div class="line">842</div><div class="line">843</div><div class="line">844</div><div class="line">845</div><div class="line">846</div><div class="line">847</div><div class="line">848</div><div class="line">849</div><div class="line">850</div><div class="line">851</div><div class="line">852</div><div class="line">853</div><div class="line">854</div><div class="line">855</div><div class="line">856</div><div class="line">857</div><div class="line">858</div><div class="line">859</div><div class="line">860</div><div class="line">861</div><div class="line">862</div><div class="line">863</div><div class="line">864</div><div class="line">865</div><div class="line">866</div><div class="line">867</div><div class="line">868</div><div class="line">869</div><div class="line">870</div><div class="line">871</div><div class="line">872</div><div class="line">873</div><div class="line">874</div><div class="line">875</div><div class="line">876</div><div class="line">877</div><div class="line">878</div><div class="line">879</div><div class="line">880</div><div class="line">881</div><div class="line">882</div><div class="line">883</div><div class="line">884</div><div class="line">885</div><div class="line">886</div><div class="line">887</div><div class="line">888</div><div class="line">889</div><div class="line">890</div><div class="line">891</div><div class="line">892</div><div class="line">893</div><div class="line">894</div><div class="line">895</div><div class="line">896</div><div class="line">897</div><div class="line">898</div><div class="line">899</div><div class="line">900</div><div class="line">901</div><div class="line">902</div><div class="line">903</div><div class="line">904</div><div class="line">905</div><div class="line">906</div><div class="line">907</div><div class="line">908</div><div class="line">909</div><div class="line">910</div><div class="line">911</div><div class="line">912</div><div class="line">913</div><div class="line">914</div><div class="line">915</div><div class="line">916</div><div class="line">917</div><div class="line">918</div><div class="line">919</div><div class="line">920</div><div class="line">921</div><div class="line">922</div><div class="line">923</div><div class="line">924</div><div class="line">925</div><div class="line">926</div><div class="line">927</div><div class="line">928</div><div class="line">929</div><div class="line">930</div><div class="line">931</div><div class="line">932</div><div class="line">933</div><div class="line">934</div><div class="line">935</div><div class="line">936</div><div class="line">937</div><div class="line">938</div><div class="line">939</div><div class="line">940</div><div class="line">941</div><div class="line">942</div><div class="line">943</div><div class="line">944</div><div class="line">945</div><div class="line">946</div><div class="line">947</div><div class="line">948</div><div class="line">949</div><div class="line">950</div><div class="line">951</div><div class="line">952</div><div class="line">953</div><div class="line">954</div><div class="line">955</div><div class="line">956</div><div class="line">957</div><div class="line">958</div><div class="line">959</div><div class="line">960</div><div class="line">961</div><div class="line">962</div><div class="line">963</div><div class="line">964</div><div class="line">965</div><div class="line">966</div><div class="line">967</div><div class="line">968</div><div class="line">969</div><div class="line">970</div><div class="line">971</div><div class="line">972</div><div class="line">973</div><div class="line">974</div><div class="line">975</div><div class="line">976</div><div class="line">977</div><div class="line">978</div><div class="line">979</div><div class="line">980</div><div class="line">981</div><div class="line">982</div><div class="line">983</div><div class="line">984</div><div class="line">985</div><div class="line">986</div><div class="line">987</div><div class="line">988</div><div class="line">989</div><div class="line">990</div><div class="line">991</div><div class="line">992</div><div class="line">993</div><div class="line">994</div><div class="line">995</div><div class="line">996</div><div class="line">997</div><div class="line">998</div><div class="line">999</div><div class="line">1000</div><div class="line">1001</div><div class="line">1002</div><div class="line">1003</div><div class="line">1004</div><div class="line">1005</div><div class="line">1006</div><div class="line">1007</div><div class="line">1008</div><div class="line">1009</div><div class="line">1010</div><div class="line">1011</div><div class="line">1012</div><div class="line">1013</div><div class="line">1014</div><div class="line">1015</div><div class="line">1016</div><div class="line">1017</div><div class="line">1018</div><div class="line">1019</div><div class="line">1020</div><div class="line">1021</div><div class="line">1022</div><div class="line">1023</div><div class="line">1024</div><div class="line">1025</div><div class="line">1026</div><div class="line">1027</div><div class="line">1028</div><div class="line">1029</div><div class="line">1030</div><div class="line">1031</div><div class="line">1032</div><div class="line">1033</div><div class="line">1034</div><div class="line">1035</div><div class="line">1036</div><div class="line">1037</div><div class="line">1038</div><div class="line">1039</div><div class="line">1040</div><div class="line">1041</div><div class="line">1042</div><div class="line">1043</div><div class="line">1044</div><div class="line">1045</div><div class="line">1046</div><div class="line">1047</div><div class="line">1048</div><div class="line">1049</div><div class="line">1050</div><div class="line">1051</div><div class="line">1052</div><div class="line">1053</div><div class="line">1054</div><div class="line">1055</div><div class="line">1056</div><div class="line">1057</div><div class="line">1058</div><div class="line">1059</div><div class="line">1060</div><div class="line">1061</div><div class="line">1062</div><div class="line">1063</div><div class="line">1064</div><div class="line">1065</div><div class="line">1066</div><div class="line">1067</div><div class="line">1068</div><div class="line">1069</div><div class="line">1070</div><div class="line">1071</div><div class="line">1072</div><div class="line">1073</div><div class="line">1074</div><div class="line">1075</div><div class="line">1076</div><div class="line">1077</div><div class="line">1078</div><div class="line">1079</div><div class="line">1080</div><div class="line">1081</div><div class="line">1082</div><div class="line">1083</div><div class="line">1084</div><div class="line">1085</div><div class="line">1086</div><div class="line">1087</div><div class="line">1088</div><div class="line">1089</div><div class="line">1090</div><div class="line">1091</div><div class="line">1092</div><div class="line">1093</div><div class="line">1094</div><div class="line">1095</div><div class="line">1096</div><div class="line">1097</div><div class="line">1098</div><div class="line">1099</div><div class="line">1100</div><div class="line">1101</div><div class="line">1102</div><div class="line">1103</div><div class="line">1104</div><div class="line">1105</div><div class="line">1106</div><div class="line">1107</div><div class="line">1108</div><div class="line">1109</div><div class="line">1110</div><div class="line">1111</div><div class="line">1112</div><div class="line">1113</div><div class="line">1114</div><div class="line">1115</div><div class="line">1116</div><div class="line">1117</div><div class="line">1118</div><div class="line">1119</div><div class="line">1120</div><div class="line">1121</div><div class="line">1122</div><div class="line">1123</div><div class="line">1124</div><div class="line">1125</div><div class="line">1126</div><div class="line">1127</div><div class="line">1128</div><div class="line">1129</div><div class="line">1130</div><div class="line">1131</div><div class="line">1132</div><div class="line">1133</div><div class="line">1134</div><div class="line">1135</div><div class="line">1136</div><div class="line">1137</div><div class="line">1138</div><div class="line">1139</div><div class="line">1140</div><div class="line">1141</div><div class="line">1142</div><div class="line">1143</div><div class="line">1144</div><div class="line">1145</div><div class="line">1146</div><div class="line">1147</div><div class="line">1148</div><div class="line">1149</div><div class="line">1150</div><div class="line">1151</div><div class="line">1152</div><div class="line">1153</div><div class="line">1154</div><div class="line">1155</div><div class="line">1156</div><div class="line">1157</div><div class="line">1158</div><div class="line">1159</div><div class="line">1160</div><div class="line">1161</div><div class="line">1162</div><div class="line">1163</div><div class="line">1164</div><div class="line">1165</div><div class="line">1166</div><div class="line">1167</div><div class="line">1168</div><div class="line">1169</div><div class="line">1170</div><div class="line">1171</div><div class="line">1172</div><div class="line">1173</div><div class="line">1174</div><div class="line">1175</div><div class="line">1176</div><div class="line">1177</div><div class="line">1178</div><div class="line">1179</div><div class="line">1180</div><div class="line">1181</div><div class="line">1182</div><div class="line">1183</div><div class="line">1184</div><div class="line">1185</div><div class="line">1186</div><div class="line">1187</div><div class="line">1188</div><div class="line">1189</div><div class="line">1190</div><div class="line">1191</div><div class="line">1192</div><div class="line">1193</div><div class="line">1194</div><div class="line">1195</div><div class="line">1196</div><div class="line">1197</div><div class="line">1198</div><div class="line">1199</div><div class="line">1200</div><div class="line">1201</div><div class="line">1202</div><div class="line">1203</div><div class="line">1204</div><div class="line">1205</div><div class="line">1206</div><div class="line">1207</div><div class="line">1208</div><div class="line">1209</div><div class="line">1210</div><div class="line">1211</div><div class="line">1212</div><div class="line">1213</div><div class="line">1214</div><div class="line">1215</div><div class="line">1216</div><div class="line">1217</div><div class="line">1218</div><div class="line">1219</div><div class="line">1220</div><div class="line">1221</div><div class="line">1222</div><div class="line">1223</div><div class="line">1224</div><div class="line">1225</div><div class="line">1226</div><div class="line">1227</div><div class="line">1228</div><div class="line">1229</div><div class="line">1230</div><div class="line">1231</div><div class="line">1232</div><div class="line">1233</div><div class="line">1234</div><div class="line">1235</div><div class="line">1236</div><div class="line">1237</div><div class="line">1238</div><div class="line">1239</div><div class="line">1240</div><div class="line">1241</div><div class="line">1242</div><div class="line">1243</div><div class="line">1244</div><div class="line">1245</div><div class="line">1246</div><div class="line">1247</div><div class="line">1248</div><div class="line">1249</div><div class="line">1250</div><div class="line">1251</div><div class="line">1252</div><div class="line">1253</div><div class="line">1254</div><div class="line">1255</div><div class="line">1256</div><div class="line">1257</div><div class="line">1258</div><div class="line">1259</div><div class="line">1260</div><div class="line">1261</div><div class="line">1262</div><div class="line">1263</div><div class="line">1264</div><div class="line">1265</div><div class="line">1266</div><div class="line">1267</div><div class="line">1268</div><div class="line">1269</div><div class="line">1270</div><div class="line">1271</div><div class="line">1272</div><div class="line">1273</div><div class="line">1274</div><div class="line">1275</div><div class="line">1276</div><div class="line">1277</div><div class="line">1278</div><div class="line">1279</div><div class="line">1280</div><div class="line">1281</div><div class="line">1282</div><div class="line">1283</div><div class="line">1284</div><div class="line">1285</div><div class="line">1286</div><div class="line">1287</div><div class="line">1288</div><div class="line">1289</div><div class="line">1290</div><div class="line">1291</div><div class="line">1292</div><div class="line">1293</div><div class="line">1294</div><div class="line">1295</div><div class="line">1296</div><div class="line">1297</div><div class="line">1298</div><div class="line">1299</div><div class="line">1300</div><div class="line">1301</div><div class="line">1302</div><div class="line">1303</div><div class="line">1304</div><div class="line">1305</div><div class="line">1306</div><div class="line">1307</div><div class="line">1308</div><div class="line">1309</div><div class="line">1310</div><div class="line">1311</div><div class="line">1312</div><div class="line">1313</div><div class="line">1314</div><div class="line">1315</div><div class="line">1316</div><div class="line">1317</div><div class="line">1318</div><div class="line">1319</div><div class="line">1320</div><div class="line">1321</div><div class="line">1322</div><div class="line">1323</div><div class="line">1324</div><div class="line">1325</div><div class="line">1326</div><div class="line">1327</div><div class="line">1328</div><div class="line">1329</div><div class="line">1330</div><div class="line">1331</div><div class="line">1332</div><div class="line">1333</div><div class="line">1334</div><div class="line">1335</div><div class="line">1336</div><div class="line">1337</div><div class="line">1338</div><div class="line">1339</div><div class="line">1340</div><div class="line">1341</div><div class="line">1342</div><div class="line">1343</div><div class="line">1344</div><div class="line">1345</div><div class="line">1346</div><div class="line">1347</div><div class="line">1348</div><div class="line">1349</div><div class="line">1350</div><div class="line">1351</div><div class="line">1352</div><div class="line">1353</div><div class="line">1354</div><div class="line">1355</div><div class="line">1356</div><div class="line">1357</div><div class="line">1358</div><div class="line">1359</div><div class="line">1360</div><div class="line">1361</div><div class="line">1362</div><div class="line">1363</div><div class="line">1364</div><div class="line">1365</div><div class="line">1366</div><div class="line">1367</div><div class="line">1368</div><div class="line">1369</div><div class="line">1370</div><div class="line">1371</div><div class="line">1372</div><div class="line">1373</div><div class="line">1374</div><div class="line">1375</div><div class="line">1376</div><div class="line">1377</div><div class="line">1378</div><div class="line">1379</div><div class="line">1380</div><div class="line">1381</div><div class="line">1382</div><div class="line">1383</div><div class="line">1384</div><div class="line">1385</div><div class="line">1386</div><div class="line">1387</div><div class="line">1388</div><div class="line">1389</div><div class="line">1390</div><div class="line">1391</div><div class="line">1392</div><div class="line">1393</div><div class="line">1394</div><div class="line">1395</div><div class="line">1396</div><div class="line">1397</div><div class="line">1398</div><div class="line">1399</div><div class="line">1400</div><div class="line">1401</div><div class="line">1402</div><div class="line">1403</div><div class="line">1404</div><div class="line">1405</div><div class="line">1406</div><div class="line">1407</div><div class="line">1408</div><div class="line">1409</div><div class="line">1410</div><div class="line">1411</div><div class="line">1412</div><div class="line">1413</div><div class="line">1414</div><div class="line">1415</div><div class="line">1416</div><div class="line">1417</div><div class="line">1418</div><div class="line">1419</div><div class="line">1420</div><div class="line">1421</div><div class="line">1422</div><div class="line">1423</div><div class="line">1424</div><div class="line">1425</div><div class="line">1426</div><div class="line">1427</div><div class="line">1428</div><div class="line">1429</div><div class="line">1430</div><div class="line">1431</div><div class="line">1432</div><div class="line">1433</div><div class="line">1434</div><div class="line">1435</div><div class="line">1436</div><div class="line">1437</div><div class="line">1438</div><div class="line">1439</div><div class="line">1440</div><div class="line">1441</div><div class="line">1442</div><div class="line">1443</div><div class="line">1444</div><div class="line">1445</div><div class="line">1446</div><div class="line">1447</div><div class="line">1448</div><div class="line">1449</div><div class="line">1450</div><div class="line">1451</div><div class="line">1452</div><div class="line">1453</div><div class="line">1454</div><div class="line">1455</div><div class="line">1456</div><div class="line">1457</div><div class="line">1458</div><div class="line">1459</div><div class="line">1460</div><div class="line">1461</div><div class="line">1462</div><div class="line">1463</div><div class="line">1464</div><div class="line">1465</div><div class="line">1466</div><div class="line">1467</div><div class="line">1468</div><div class="line">1469</div><div class="line">1470</div><div class="line">1471</div><div class="line">1472</div><div class="line">1473</div><div class="line">1474</div><div class="line">1475</div><div class="line">1476</div><div class="line">1477</div><div class="line">1478</div><div class="line">1479</div><div class="line">1480</div><div class="line">1481</div><div class="line">1482</div><div class="line">1483</div><div class="line">1484</div><div class="line">1485</div><div class="line">1486</div><div class="line">1487</div><div class="line">1488</div><div class="line">1489</div><div class="line">1490</div><div class="line">1491</div><div class="line">1492</div><div class="line">1493</div><div class="line">1494</div><div class="line">1495</div><div class="line">1496</div><div class="line">1497</div><div class="line">1498</div><div class="line">1499</div><div class="line">1500</div><div class="line">1501</div><div class="line">1502</div><div class="line">1503</div><div class="line">1504</div><div class="line">1505</div><div class="line">1506</div><div class="line">1507</div><div class="line">1508</div><div class="line">1509</div><div class="line">1510</div><div class="line">1511</div><div class="line">1512</div><div class="line">1513</div><div class="line">1514</div><div class="line">1515</div><div class="line">1516</div><div class="line">1517</div><div class="line">1518</div><div class="line">1519</div><div class="line">1520</div><div class="line">1521</div><div class="line">1522</div><div class="line">1523</div><div class="line">1524</div><div class="line">1525</div><div class="line">1526</div><div class="line">1527</div><div class="line">1528</div><div class="line">1529</div><div class="line">1530</div><div class="line">1531</div><div class="line">1532</div><div class="line">1533</div><div class="line">1534</div><div class="line">1535</div><div class="line">1536</div><div class="line">1537</div><div class="line">1538</div><div class="line">1539</div><div class="line">1540</div><div class="line">1541</div><div class="line">1542</div><div class="line">1543</div><div class="line">1544</div><div class="line">1545</div><div class="line">1546</div><div class="line">1547</div><div class="line">1548</div><div class="line">1549</div><div class="line">1550</div><div class="line">1551</div><div class="line">1552</div><div class="line">1553</div><div class="line">1554</div><div class="line">1555</div><div class="line">1556</div><div class="line">1557</div><div class="line">1558</div><div class="line">1559</div><div class="line">1560</div><div class="line">1561</div><div class="line">1562</div><div class="line">1563</div><div class="line">1564</div><div class="line">1565</div><div class="line">1566</div><div class="line">1567</div><div class="line">1568</div><div class="line">1569</div><div class="line">1570</div><div class="line">1571</div><div class="line">1572</div><div class="line">1573</div><div class="line">1574</div><div class="line">1575</div><div class="line">1576</div><div class="line">1577</div><div class="line">1578</div><div class="line">1579</div><div class="line">1580</div><div class="line">1581</div><div class="line">1582</div><div class="line">1583</div><div class="line">1584</div><div class="line">1585</div><div class="line">1586</div><div class="line">1587</div><div class="line">1588</div><div class="line">1589</div><div class="line">1590</div><div class="line">1591</div><div class="line">1592</div><div class="line">1593</div><div class="line">1594</div><div class="line">1595</div><div class="line">1596</div><div class="line">1597</div><div class="line">1598</div><div class="line">1599</div><div class="line">1600</div><div class="line">1601</div><div class="line">1602</div><div class="line">1603</div><div class="line">1604</div><div class="line">1605</div><div class="line">1606</div><div class="line">1607</div><div class="line">1608</div><div class="line">1609</div><div class="line">1610</div><div class="line">1611</div><div class="line">1612</div><div class="line">1613</div><div class="line">1614</div><div class="line">1615</div><div class="line">1616</div><div class="line">1617</div><div class="line">1618</div><div class="line">1619</div><div class="line">1620</div><div class="line">1621</div><div class="line">1622</div><div class="line">1623</div><div class="line">1624</div><div class="line">1625</div><div class="line">1626</div><div class="line">1627</div><div class="line">1628</div><div class="line">1629</div><div class="line">1630</div><div class="line">1631</div><div class="line">1632</div><div class="line">1633</div><div class="line">1634</div><div class="line">1635</div><div class="line">1636</div><div class="line">1637</div><div class="line">1638</div><div class="line">1639</div><div class="line">1640</div><div class="line">1641</div><div class="line">1642</div><div class="line">1643</div><div class="line">1644</div><div class="line">1645</div><div class="line">1646</div><div class="line">1647</div><div class="line">1648</div><div class="line">1649</div><div class="line">1650</div><div class="line">1651</div><div class="line">1652</div><div class="line">1653</div><div class="line">1654</div><div class="line">1655</div><div class="line">1656</div><div class="line">1657</div><div class="line">1658</div><div class="line">1659</div><div class="line">1660</div><div class="line">1661</div><div class="line">1662</div><div class="line">1663</div><div class="line">1664</div><div class="line">1665</div><div class="line">1666</div><div class="line">1667</div><div class="line">1668</div><div class="line">1669</div><div class="line">1670</div><div class="line">1671</div><div class="line">1672</div><div class="line">1673</div><div class="line">1674</div><div class="line">1675</div><div class="line">1676</div><div class="line">1677</div><div class="line">1678</div><div class="line">1679</div><div class="line">1680</div><div class="line">1681</div><div class="line">1682</div><div class="line">1683</div><div class="line">1684</div><div class="line">1685</div><div class="line">1686</div><div class="line">1687</div><div class="line">1688</div><div class="line">1689</div><div class="line">1690</div><div class="line">1691</div><div class="line">1692</div><div class="line">1693</div><div class="line">1694</div><div class="line">1695</div><div class="line">1696</div><div class="line">1697</div><div class="line">1698</div><div class="line">1699</div><div class="line">1700</div><div class="line">1701</div><div class="line">1702</div><div class="line">1703</div><div class="line">1704</div><div class="line">1705</div><div class="line">1706</div><div class="line">1707</div><div class="line">1708</div><div class="line">1709</div><div class="line">1710</div><div class="line">1711</div><div class="line">1712</div><div class="line">1713</div><div class="line">1714</div><div class="line">1715</div><div class="line">1716</div><div class="line">1717</div><div class="line">1718</div><div class="line">1719</div><div class="line">1720</div><div class="line">1721</div><div class="line">1722</div><div class="line">1723</div><div class="line">1724</div><div class="line">1725</div><div class="line">1726</div><div class="line">1727</div><div class="line">1728</div><div class="line">1729</div><div class="line">1730</div><div class="line">1731</div><div class="line">1732</div><div class="line">1733</div><div class="line">1734</div><div class="line">1735</div><div class="line">1736</div><div class="line">1737</div><div class="line">1738</div><div class="line">1739</div><div class="line">1740</div><div class="line">1741</div><div class="line">1742</div><div class="line">1743</div><div class="line">1744</div><div class="line">1745</div><div class="line">1746</div><div class="line">1747</div><div class="line">1748</div><div class="line">1749</div><div class="line">1750</div><div class="line">1751</div><div class="line">1752</div><div class="line">1753</div><div class="line">1754</div><div class="line">1755</div><div class="line">1756</div><div class="line">1757</div><div class="line">1758</div><div class="line">1759</div><div class="line">1760</div><div class="line">1761</div><div class="line">1762</div><div class="line">1763</div><div class="line">1764</div><div class="line">1765</div><div class="line">1766</div><div class="line">1767</div><div class="line">1768</div><div class="line">1769</div><div class="line">1770</div><div class="line">1771</div><div class="line">1772</div><div class="line">1773</div><div class="line">1774</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"></div><div class="line">  Reference Cycle Garbage Collection</div><div class="line">  ==================================</div><div class="line"></div><div class="line">  Neil Schemenauer &lt;nas@arctrix.com&gt;</div><div class="line"></div><div class="line">  Based on a post on the python-dev list.  Ideas from Guido van Rossum,</div><div class="line">  Eric Tiedemann, and various others.</div><div class="line"></div><div class="line">  http://www.arctrix.com/nas/python/gc/</div><div class="line">  http://www.python.org/pipermail/python-dev/2000-March/003869.html</div><div class="line">  http://www.python.org/pipermail/python-dev/2000-March/004010.html</div><div class="line">  http://www.python.org/pipermail/python-dev/2000-March/004022.html</div><div class="line"></div><div class="line">  For a highlevel view of the collection process, read the collect</div><div class="line">  function.</div><div class="line"></div><div class="line">*/</div><div class="line"></div><div class="line">#include "Python.h"</div><div class="line">#include "frameobject.h"        /* for PyFrame_ClearFreeList */</div><div class="line"></div><div class="line">/* </div><div class="line"> * 带有垃圾回收头部的对象的内存模型</div><div class="line"> * ------------------------------</div><div class="line"> * g          o</div><div class="line"> * |PyGC_Head | PyObject | other|</div><div class="line"> * ------------------------------</div><div class="line"> *           </div><div class="line"> * 因此给定地址o计算g就是将地址减少sizeof(PyGC_HEAD)</div><div class="line"> * </div><div class="line"> * 说明：</div><div class="line"> * 1. 垃圾管理有两部分 引用计数 和 循环垃圾收集器</div><div class="line"> * 2. 简单的对象不产生循环引用使用引用计数即可：例如 int、float、string等</div><div class="line"> * 3. 有可能产生循环引用的对象(容器类)才需要循环垃圾收集器: 例如 list、dict</div><div class="line"> * 4. Python对一些容器类对象进行优化，如果容器内的元素不会产生循环引用，</div><div class="line"> *    则不会纳入循环引用管理: 例如 &#123;'a': 1&#125;, [1, 2, 'a']</div><div class="line"> */</div><div class="line">/* Get an object's GC head */</div><div class="line">#define AS_GC(o) ((PyGC_Head *)(o)-1)</div><div class="line"></div><div class="line">/* Get the object given the GC head */</div><div class="line">#define FROM_GC(g) ((PyObject *)(((PyGC_Head *)g)+1))</div><div class="line"></div><div class="line">/*** Global GC state ***/</div><div class="line"></div><div class="line">/* 每一代的寿命是比该代年轻的那代运行的次数</div><div class="line"> * 例如 第1代没运行一次，第2代年龄增加一岁</div><div class="line"> */</div><div class="line"></div><div class="line">struct gc_generation &#123;</div><div class="line">    PyGC_Head head;</div><div class="line">    /* 寿命 */</div><div class="line">    int threshold; /* collection threshold */</div><div class="line">    /* 年龄，到了寿命就该回收了 */</div><div class="line">    int count; /* count of allocations or collections of younger</div><div class="line">                  generations */</div><div class="line">&#125;;</div><div class="line"></div><div class="line">/* Python只有3代 */</div><div class="line">#define NUM_GENERATIONS 3</div><div class="line">#define GEN_HEAD(n) (&amp;generations[n].head)</div><div class="line"></div><div class="line">/* linked lists of container objects */</div><div class="line">/* linked lists结构，初始化时每个链表指向自己的头</div><div class="line"> * 内存模型如下:</div><div class="line"> * ---------------------------</div><div class="line"> * g0                        |</div><div class="line"> * |next(g0)|prev(g0)|0|700|0|</div><div class="line"> * g1                        |</div><div class="line"> * |next(g1)|prev(g1)|0|10 |0| </div><div class="line"> * g2                         |</div><div class="line"> * |next(g2)|prev(g2)|0|10 |0|</div><div class="line"> * ---------------------------</div><div class="line"> * generation[i].head.next = generation[i].head.prev = &amp;generation[i]</div><div class="line"> * &amp;generation[i] == &amp;generation[i].head</div><div class="line"> */</div><div class="line">static struct gc_generation generations[NUM_GENERATIONS] = &#123;</div><div class="line">    /* PyGC_Head,                               threshold,      count */</div><div class="line">    &#123;&#123;&#123;GEN_HEAD(0), GEN_HEAD(0), 0&#125;&#125;,           700,            0&#125;,</div><div class="line">    &#123;&#123;&#123;GEN_HEAD(1), GEN_HEAD(1), 0&#125;&#125;,           10,             0&#125;,</div><div class="line">    &#123;&#123;&#123;GEN_HEAD(2), GEN_HEAD(2), 0&#125;&#125;,           10,             0&#125;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">PyGC_Head *_PyGC_generation0 = GEN_HEAD(0);</div><div class="line"></div><div class="line">static int enabled = 1; /* automatic collection enabled? */</div><div class="line"></div><div class="line">/* true if we are currently running the collector */</div><div class="line">static int collecting = 0;</div><div class="line"></div><div class="line"></div><div class="line">/* list of uncollectable objects  */</div><div class="line"></div><div class="line">/* unreachable:</div><div class="line"> * 没有外部引用，只有被彼此循环引用的对象。例如</div><div class="line"> * list1=[];list2=[list1];list1.append(list2)</div><div class="line"> * del list1; del list2</div><div class="line"> * 那么list1和list2不能通过其他对象到达</div><div class="line"> *</div><div class="line"> * uncollectable:</div><div class="line"> * unreachable并且有 __del__ 方法的对象</div><div class="line"> *  __del__由用户自定义，可能引用了其他的对象。</div><div class="line"> */</div><div class="line">static PyObject *garbage = NULL;</div><div class="line"></div><div class="line">/* Python string to use if unhandled exception occurs */</div><div class="line">static PyObject *gc_str = NULL;</div><div class="line"></div><div class="line">/* Python string used to look for __del__ attribute. */</div><div class="line">static PyObject *delstr = NULL;</div><div class="line"></div><div class="line">/* This is the number of objects who survived the last full collection. It</div><div class="line">   approximates the number of long lived objects tracked by the GC.</div><div class="line"></div><div class="line">   (by "full collection", we mean a collection of the oldest generation).</div><div class="line">*/</div><div class="line"></div><div class="line">/* 经过一次第三代收集还存活的则为 long_lived </div><div class="line"> * 运行一次第三代的垃圾回收叫 full collection。</div><div class="line"> */</div><div class="line">static Py_ssize_t long_lived_total = 0;</div><div class="line"></div><div class="line">/* This is the number of objects who survived all "non-full" collections,</div><div class="line">   and are awaiting to undergo a full collection for the first time.</div><div class="line">*/</div><div class="line">/* 第二代回收时，不能被回收而移动到第三代的对象个数 */</div><div class="line">static Py_ssize_t long_lived_pending = 0;</div><div class="line"></div><div class="line">/*</div><div class="line">   NOTE: about the counting of long-lived objects.</div><div class="line"></div><div class="line">   To limit the cost of garbage collection, there are two strategies;</div><div class="line">     - make each collection faster, e.g. by scanning fewer objects</div><div class="line">     - do less collections</div><div class="line">   This heuristic is about the latter strategy.</div><div class="line"></div><div class="line">   In addition to the various configurable thresholds, we only trigger a</div><div class="line">   full collection if the ratio</div><div class="line">    long_lived_pending / long_lived_total</div><div class="line">   is above a given value (hardwired to 25%).</div><div class="line"></div><div class="line">   The reason is that, while "non-full" collections (i.e., collections of</div><div class="line">   the young and middle generations) will always examine roughly the same</div><div class="line">   number of objects -- determined by the aforementioned thresholds --,</div><div class="line">   the cost of a full collection is proportional to the total number of</div><div class="line">   long-lived objects, which is virtually unbounded.</div><div class="line"></div><div class="line">   Indeed, it has been remarked that doing a full collection every</div><div class="line">   &lt;constant number&gt; of object creations entails a dramatic performance</div><div class="line">   degradation in workloads which consist in creating and storing lots of</div><div class="line">   long-lived objects (e.g. building a large list of GC-tracked objects would</div><div class="line">   show quadratic performance, instead of linear as expected: see issue #4074).</div><div class="line"></div><div class="line">   Using the above ratio, instead, yields amortized linear performance in</div><div class="line">   the total number of objects (the effect of which can be summarized</div><div class="line">   thusly: "each full garbage collection is more and more costly as the</div><div class="line">   number of objects grows, but we do fewer and fewer of them").</div><div class="line"></div><div class="line">   This heuristic was suggested by Martin von Löwis on python-dev in</div><div class="line">   June 2008. His original analysis and proposal can be found at:</div><div class="line">    http://mail.python.org/pipermail/python-dev/2008-June/080579.html</div><div class="line">*/</div><div class="line"></div><div class="line">/*</div><div class="line">   NOTE: about untracking of mutable objects.</div><div class="line"></div><div class="line">   Certain types of container cannot participate in a reference cycle, and</div><div class="line">   so do not need to be tracked by the garbage collector. Untracking these</div><div class="line">   objects reduces the cost of garbage collections. However, determining</div><div class="line">   which objects may be untracked is not free, and the costs must be</div><div class="line">   weighed against the benefits for garbage collection.</div><div class="line"></div><div class="line">   There are two possible strategies for when to untrack a container:</div><div class="line"></div><div class="line">   i) When the container is created.</div><div class="line">   ii) When the container is examined by the garbage collector.</div><div class="line"></div><div class="line">   Tuples containing only immutable objects (integers, strings etc, and</div><div class="line">   recursively, tuples of immutable objects) do not need to be tracked.</div><div class="line">   The interpreter creates a large number of tuples, many of which will</div><div class="line">   not survive until garbage collection. It is therefore not worthwhile</div><div class="line">   to untrack eligible tuples at creation time.</div><div class="line"></div><div class="line">   Instead, all tuples except the empty tuple are tracked when created.</div><div class="line">   During garbage collection it is determined whether any surviving tuples</div><div class="line">   can be untracked. A tuple can be untracked if all of its contents are</div><div class="line">   already not tracked. Tuples are examined for untracking in all garbage</div><div class="line">   collection cycles. It may take more than one cycle to untrack a tuple.</div><div class="line"></div><div class="line">   Dictionaries containing only immutable objects also do not need to be</div><div class="line">   tracked. Dictionaries are untracked when created. If a tracked item is</div><div class="line">   inserted into a dictionary (either as a key or value), the dictionary</div><div class="line">   becomes tracked. During a full garbage collection (all generations),</div><div class="line">   the collector will untrack any dictionaries whose contents are not</div><div class="line">   tracked.</div><div class="line"></div><div class="line">   The module provides the python function is_tracked(obj), which returns</div><div class="line">   the CURRENT tracking status of the object. Subsequent garbage</div><div class="line">   collections may change the tracking status of the object.</div><div class="line"></div><div class="line">   Untracking of certain containers was introduced in issue #4688, and</div><div class="line">   the algorithm was refined in response to issue #14775.</div><div class="line">*/</div><div class="line"> /* 简单说：</div><div class="line">  * 垃圾回收的效率取决于纳入垃圾管理的对象的数量</div><div class="line">  */</div><div class="line"></div><div class="line">/* set for debugging information */</div><div class="line">#define DEBUG_STATS             (1&lt;&lt;0) /* print collection statistics */</div><div class="line">#define DEBUG_COLLECTABLE       (1&lt;&lt;1) /* print collectable objects */</div><div class="line">#define DEBUG_UNCOLLECTABLE     (1&lt;&lt;2) /* print uncollectable objects */</div><div class="line">#define DEBUG_INSTANCES         (1&lt;&lt;3) /* print instances */</div><div class="line">#define DEBUG_OBJECTS           (1&lt;&lt;4) /* print other objects */</div><div class="line">#define DEBUG_SAVEALL           (1&lt;&lt;5) /* save all garbage in gc.garbage */</div><div class="line">#define DEBUG_LEAK              DEBUG_COLLECTABLE | \</div><div class="line">                DEBUG_UNCOLLECTABLE | \</div><div class="line">                DEBUG_INSTANCES | \</div><div class="line">                DEBUG_OBJECTS | \</div><div class="line">                DEBUG_SAVEALL</div><div class="line">static int debug;</div><div class="line">static PyObject *tmod = NULL;</div><div class="line"></div><div class="line">/*--------------------------------------------------------------------------</div><div class="line">gc_refs values.</div><div class="line"></div><div class="line">Between collections, every gc'ed object has one of two gc_refs values:</div><div class="line"></div><div class="line">GC_UNTRACKED</div><div class="line">    The initial state; objects returned by PyObject_GC_Malloc are in this</div><div class="line">    state.  The object doesn't live in any generation list, and its</div><div class="line">    tp_traverse slot must not be called.</div><div class="line">    </div><div class="line">    没有纳入收集器管理的对象，例如 刚通过PyObject_GC_Malloc初始化的对象，</div><div class="line">    int，float等，当然也不存在任何"代"中。</div><div class="line"></div><div class="line">GC_REACHABLE</div><div class="line">    The object lives in some generation list, and its tp_traverse is safe to</div><div class="line">    call.  An object transitions to GC_REACHABLE when PyObject_GC_Track</div><div class="line">    is called.</div><div class="line"></div><div class="line">    纳入了收集器管理的对象，并且可以通过各对象的tp_traverse处理的对象</div><div class="line">    纳入管理，并且在有向图中可以到达(不存在循环引用)</div><div class="line"></div><div class="line"></div><div class="line">代中对象的处理和gc_refs：</div><div class="line">1. 遍历整个代中的对象，将对象中的所有元素gc_refs-1</div><div class="line">2. 再次遍历整个代中的对象，此时gc_refs：</div><div class="line">   0：对象只被代中的其他对象引用，例如：</div><div class="line">      list1=[]; list2=[list1];del list1;del list2</div><div class="line">      设置gc_refs = GC_TENTATIVELY_UNREACHABLE</div><div class="line"></div><div class="line">   &gt;0: 对象有外部引用</div><div class="line">      设置gc_refs = 1</div><div class="line"></div><div class="line">3. 遍历代中的对象中的元素，此时gc_refs：</div><div class="line">   GC_TENTATIVELY_UNREACHABLE: </div><div class="line">       说明之前作为代中的对象处理过，确实是unreachable</div><div class="line">       设置GC_REACHABLE</div><div class="line"></div><div class="line">   1，GC_UNTRACKED，GC_REACHABLE： </div><div class="line">       保持不变，仍在代中</div><div class="line"></div><div class="line">During a collection, gc_refs can temporarily take on other states:</div><div class="line"></div><div class="line"></div><div class="line">&gt;= 0</div><div class="line">    At the start of a collection, update_refs() copies the true refcount</div><div class="line">    to gc_refs, for each object in the generation being collected.</div><div class="line">    subtract_refs() then adjusts gc_refs so that it equals the number of</div><div class="line">    times an object is referenced directly from outside the generation</div><div class="line">    being collected.</div><div class="line">    gc_refs remains &gt;= 0 throughout these steps.</div><div class="line"></div><div class="line">GC_TENTATIVELY_UNREACHABLE</div><div class="line">    move_unreachable() then moves objects not reachable (whether directly or</div><div class="line">    indirectly) from outside the generation into an "unreachable" set.</div><div class="line">    Objects that are found to be reachable have gc_refs set to GC_REACHABLE</div><div class="line">    again.  Objects that are found to be unreachable have gc_refs set to</div><div class="line">    GC_TENTATIVELY_UNREACHABLE.  It's "tentatively" because the pass doing</div><div class="line">    this can't be sure until it ends, and GC_TENTATIVELY_UNREACHABLE may</div><div class="line">    transition back to GC_REACHABLE.</div><div class="line"></div><div class="line">    遍历时的临时状态，当遍历时将暂时不能到达的对象设置为该状态。</div><div class="line"></div><div class="line">    Only objects with GC_TENTATIVELY_UNREACHABLE still set are candidates</div><div class="line">    for collection.  If it's decided not to collect such an object (e.g.,</div><div class="line">    it has a __del__ method), its gc_refs is restored to GC_REACHABLE again.</div><div class="line">----------------------------------------------------------------------------</div><div class="line">*/</div><div class="line">#define GC_UNTRACKED                    _PyGC_REFS_UNTRACKED</div><div class="line">#define GC_REACHABLE                    _PyGC_REFS_REACHABLE</div><div class="line">#define GC_TENTATIVELY_UNREACHABLE      _PyGC_REFS_TENTATIVELY_UNREACHABLE</div><div class="line"></div><div class="line">#define IS_TRACKED(o) ((AS_GC(o))-&gt;gc.gc_refs != GC_UNTRACKED)</div><div class="line">#define IS_REACHABLE(o) ((AS_GC(o))-&gt;gc.gc_refs == GC_REACHABLE)</div><div class="line">#define IS_TENTATIVELY_UNREACHABLE(o) ( \</div><div class="line">    (AS_GC(o))-&gt;gc.gc_refs == GC_TENTATIVELY_UNREACHABLE)</div><div class="line"></div><div class="line">/*** list functions ***/</div><div class="line"></div><div class="line">static void</div><div class="line">gc_list_init(PyGC_Head *list)</div><div class="line">&#123;</div><div class="line">    list-&gt;gc.gc_prev = list;</div><div class="line">    list-&gt;gc.gc_next = list;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static int</div><div class="line">gc_list_is_empty(PyGC_Head *list)</div><div class="line">&#123;</div><div class="line">    return (list-&gt;gc.gc_next == list);</div><div class="line">&#125;</div><div class="line"></div><div class="line">#if 0</div><div class="line">/* This became unused after gc_list_move() was introduced. */</div><div class="line">/* Append `node` to `list`. */</div><div class="line">static void</div><div class="line">gc_list_append(PyGC_Head *node, PyGC_Head *list)</div><div class="line">&#123;</div><div class="line">    node-&gt;gc.gc_next = list;</div><div class="line">    node-&gt;gc.gc_prev = list-&gt;gc.gc_prev;</div><div class="line">    node-&gt;gc.gc_prev-&gt;gc.gc_next = node;</div><div class="line">    list-&gt;gc.gc_prev = node;</div><div class="line">&#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">/* Remove `node` from the gc list it's currently in. */</div><div class="line">static void</div><div class="line">gc_list_remove(PyGC_Head *node)</div><div class="line">&#123;</div><div class="line">    node-&gt;gc.gc_prev-&gt;gc.gc_next = node-&gt;gc.gc_next;</div><div class="line">    node-&gt;gc.gc_next-&gt;gc.gc_prev = node-&gt;gc.gc_prev;</div><div class="line">    node-&gt;gc.gc_next = NULL; /* object is not currently tracked */</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Move `node` from the gc list it's currently in (which is not explicitly</div><div class="line"> * named here) to the end of `list`.  This is semantically the same as</div><div class="line"> * gc_list_remove(node) followed by gc_list_append(node, list).</div><div class="line"> */</div><div class="line">static void</div><div class="line">gc_list_move(PyGC_Head *node, PyGC_Head *list)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *new_prev;</div><div class="line">    PyGC_Head *current_prev = node-&gt;gc.gc_prev;</div><div class="line">    PyGC_Head *current_next = node-&gt;gc.gc_next;</div><div class="line">    /* Unlink from current list. */</div><div class="line">    current_prev-&gt;gc.gc_next = current_next;</div><div class="line">    current_next-&gt;gc.gc_prev = current_prev;</div><div class="line">    /* Relink at end of new list. */</div><div class="line">    new_prev = node-&gt;gc.gc_prev = list-&gt;gc.gc_prev;</div><div class="line">    new_prev-&gt;gc.gc_next = list-&gt;gc.gc_prev = node;</div><div class="line">    node-&gt;gc.gc_next = list;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* append list `from` onto list `to`; `from` becomes an empty list */</div><div class="line">/* 将 from 整体挂到 to 的头部 */</div><div class="line">static void</div><div class="line">gc_list_merge(PyGC_Head *from, PyGC_Head *to)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *tail;</div><div class="line">    assert(from != to);</div><div class="line">    if (!gc_list_is_empty(from)) &#123;</div><div class="line">        tail = to-&gt;gc.gc_prev;</div><div class="line">        tail-&gt;gc.gc_next = from-&gt;gc.gc_next;</div><div class="line">        tail-&gt;gc.gc_next-&gt;gc.gc_prev = tail;</div><div class="line">        to-&gt;gc.gc_prev = from-&gt;gc.gc_prev;</div><div class="line">        to-&gt;gc.gc_prev-&gt;gc.gc_next = to;</div><div class="line">    &#125;</div><div class="line">    gc_list_init(from);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static Py_ssize_t</div><div class="line">gc_list_size(PyGC_Head *list)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *gc;</div><div class="line">    Py_ssize_t n = 0;</div><div class="line">    for (gc = list-&gt;gc.gc_next; gc != list; gc = gc-&gt;gc.gc_next) &#123;</div><div class="line">        n++;</div><div class="line">    &#125;</div><div class="line">    return n;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Append objects in a GC list to a Python list.</div><div class="line"> * Return 0 if all OK, &lt; 0 if error (out of memory for list).</div><div class="line"> */</div><div class="line">static int</div><div class="line">append_objects(PyObject *py_list, PyGC_Head *gc_list)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *gc;</div><div class="line">    for (gc = gc_list-&gt;gc.gc_next; gc != gc_list; gc = gc-&gt;gc.gc_next) &#123;</div><div class="line">        PyObject *op = FROM_GC(gc);</div><div class="line">        if (op != py_list) &#123;</div><div class="line">            if (PyList_Append(py_list, op)) &#123;</div><div class="line">                return -1; /* exception */</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*** end of list stuff ***/</div><div class="line"></div><div class="line"></div><div class="line">/* Set all gc_refs = ob_refcnt.  After this, gc_refs is &gt; 0 for all objects</div><div class="line"> * in containers, and is GC_REACHABLE for all tracked gc objects not in</div><div class="line"> * containers.</div><div class="line"> */</div><div class="line">static void</div><div class="line">update_refs(PyGC_Head *containers)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *gc = containers-&gt;gc.gc_next;</div><div class="line">    for (; gc != containers; gc = gc-&gt;gc.gc_next) &#123;</div><div class="line">        assert(gc-&gt;gc.gc_refs == GC_REACHABLE);</div><div class="line">        gc-&gt;gc.gc_refs = Py_REFCNT(FROM_GC(gc));</div><div class="line">        /* Python's cyclic gc should never see an incoming refcount</div><div class="line">         * of 0:  if something decref'ed to 0, it should have been</div><div class="line">         * deallocated immediately at that time.</div><div class="line">         * Possible cause (if the assert triggers):  a tp_dealloc</div><div class="line">         * routine left a gc-aware object tracked during its teardown</div><div class="line">         * phase, and did something-- or allowed something to happen --</div><div class="line">         * that called back into Python.  gc can trigger then, and may</div><div class="line">         * see the still-tracked dying object.  Before this assert</div><div class="line">         * was added, such mistakes went on to allow gc to try to</div><div class="line">         * delete the object again.  In a debug build, that caused</div><div class="line">         * a mysterious segfault, when _Py_ForgetReference tried</div><div class="line">         * to remove the object from the doubly-linked list of all</div><div class="line">         * objects a second time.  In a release build, an actual</div><div class="line">         * double deallocation occurred, which leads to corruption</div><div class="line">         * of the allocator's internal bookkeeping pointers.  That's</div><div class="line">         * so serious that maybe this should be a release-build</div><div class="line">         * check instead of an assert?</div><div class="line">         */</div><div class="line">        assert(gc-&gt;gc.gc_refs != 0);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* A traversal callback for subtract_refs. */</div><div class="line">static int</div><div class="line">visit_decref(PyObject *op, void *data)</div><div class="line">&#123;</div><div class="line">    assert(op != NULL);</div><div class="line">    if (PyObject_IS_GC(op)) &#123;</div><div class="line">        PyGC_Head *gc = AS_GC(op);</div><div class="line">        /* We're only interested in gc_refs for objects in the</div><div class="line">         * generation being collected, which can be recognized</div><div class="line">         * because only they have positive gc_refs.</div><div class="line">         */</div><div class="line">        assert(gc-&gt;gc.gc_refs != 0); /* else refcount was too small */</div><div class="line">        if (gc-&gt;gc.gc_refs &gt; 0)</div><div class="line">            gc-&gt;gc.gc_refs--;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Subtract internal references from gc_refs.  After this, gc_refs is &gt;= 0</div><div class="line"> * for all objects in containers, and is GC_REACHABLE for all tracked gc</div><div class="line"> * objects not in containers.  The ones with gc_refs &gt; 0 are directly</div><div class="line"> * reachable from outside containers, and so can't be collected.</div><div class="line"> */</div><div class="line">/*</div><div class="line"> * 调用容器类的tp_traverse对每个元素的gc_refs-1，</div><div class="line"> * 如果gc_refs&gt;0说明元素在该容器外还有引用，所以不能回收</div><div class="line"> */</div><div class="line">static void</div><div class="line">subtract_refs(PyGC_Head *containers)</div><div class="line">&#123;</div><div class="line">    traverseproc traverse;</div><div class="line">    PyGC_Head *gc = containers-&gt;gc.gc_next;</div><div class="line">    for (; gc != containers; gc=gc-&gt;gc.gc_next) &#123;</div><div class="line">        traverse = Py_TYPE(FROM_GC(gc))-&gt;tp_traverse;</div><div class="line">        (void) traverse(FROM_GC(gc),</div><div class="line">                       (visitproc)visit_decref,</div><div class="line">                       NULL);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* A traversal callback for move_unreachable. */</div><div class="line">/* op 是容器类的元素；reachable是代本身 */</div><div class="line">static int</div><div class="line">visit_reachable(PyObject *op, PyGC_Head *reachable)</div><div class="line">&#123;</div><div class="line">    if (PyObject_IS_GC(op)) &#123;</div><div class="line">        PyGC_Head *gc = AS_GC(op);</div><div class="line">        const Py_ssize_t gc_refs = gc-&gt;gc.gc_refs;</div><div class="line"></div><div class="line">        if (gc_refs == 0) &#123;</div><div class="line">            /* This is in move_unreachable's 'young' list, but</div><div class="line">             * the traversal hasn't yet gotten to it.  All</div><div class="line">             * we need to do is tell move_unreachable that it's</div><div class="line">             * reachable.</div><div class="line">             */</div><div class="line">            /*</div><div class="line">             * 元素没有引用，说明只有元素所在的容器本身引用该元素</div><div class="line">             * 举例： list1 = []; list2=[]; list1.append(list2); </div><div class="line">             *        del list2</div><div class="line">             * </div><div class="line">             * list1-&gt;ob_refcnt == 1, list-&gt;gc_refs == 1</div><div class="line">             * list2-&gt;ob_refcnt == 1, list-&gt;gc_refs == 0</div><div class="line">             *</div><div class="line">             * 所以：</div><div class="line">             * list2作为list1的元素进入当前的处理，依然是reachable</div><div class="line">             */</div><div class="line">            gc-&gt;gc.gc_refs = 1;</div><div class="line">        &#125;</div><div class="line">        else if (gc_refs == GC_TENTATIVELY_UNREACHABLE) &#123;</div><div class="line">            /* This had gc_refs = 0 when move_unreachable got</div><div class="line">             * to it, but turns out it's reachable after all.</div><div class="line">             * Move it back to move_unreachable's 'young' list,</div><div class="line">             * and move_unreachable will eventually get to it</div><div class="line">             * again.</div><div class="line">             */</div><div class="line">            /*</div><div class="line">             * 元素之前经历过1次move_unreachable处理并且被认为是unreachable</div><div class="line">             * 例如：</div><div class="line">             * list1=[];list2=[list1]; list1.append(list2)</div><div class="line">             * del list1;</div><div class="line">             *</div><div class="line">             * 第一次，list1作为容器被move_unreachable处理</div><div class="line">             * 会被标记为GC_TENTATIVELY_UNREACHABLE，认为其可以被回收</div><div class="line">             *</div><div class="line">             * 第二次，list1作为list2的元素会进入到该处</div><div class="line">             * 此时证明list1确实是list2的元素，是reachable的</div><div class="line">             *</div><div class="line">             * 这里的reachable为代链表本身，就是将gc移动到了链表尾端</div><div class="line">             */</div><div class="line">            gc_list_move(gc, reachable);</div><div class="line">            gc-&gt;gc.gc_refs = 1;</div><div class="line">        &#125;</div><div class="line">        /* Else there's nothing to do.</div><div class="line">         * If gc_refs &gt; 0, it must be in move_unreachable's 'young'</div><div class="line">         * list, and move_unreachable will eventually get to it.</div><div class="line">         * If gc_refs == GC_REACHABLE, it's either in some other</div><div class="line">         * generation so we don't care about it, or move_unreachable</div><div class="line">         * already dealt with it.</div><div class="line">         * If gc_refs == GC_UNTRACKED, it must be ignored.</div><div class="line">         */</div><div class="line">        /*</div><div class="line">         * gc_refs &gt; 0 : 处理过了证明是reachable</div><div class="line">         * GC_REACHABLE：标记为reachable的元素</div><div class="line">         * GC_UNTRACKED：不需要循环垃圾收集器处理的元素</div><div class="line">         */</div><div class="line">         else &#123;</div><div class="line">            assert(gc_refs &gt; 0</div><div class="line">                   || gc_refs == GC_REACHABLE</div><div class="line">                   || gc_refs == GC_UNTRACKED);</div><div class="line">         &#125;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Move the unreachable objects from young to unreachable.  After this,</div><div class="line"> * all objects in young have gc_refs = GC_REACHABLE, and all objects in</div><div class="line"> * unreachable have gc_refs = GC_TENTATIVELY_UNREACHABLE.  All tracked</div><div class="line"> * gc objects not in young or unreachable still have gc_refs = GC_REACHABLE.</div><div class="line"> * All objects in young after this are directly or indirectly reachable</div><div class="line"> * from outside the original young; and all objects in unreachable are</div><div class="line"> * not.</div><div class="line"> */</div><div class="line">static void</div><div class="line">move_unreachable(PyGC_Head *young, PyGC_Head *unreachable)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *gc = young-&gt;gc.gc_next;</div><div class="line"></div><div class="line">    /* Invariants:  all objects "to the left" of us in young have gc_refs</div><div class="line">     * = GC_REACHABLE, and are indeed reachable (directly or indirectly)</div><div class="line">     * from outside the young list as it was at entry.  All other objects</div><div class="line">     * from the original young "to the left" of us are in unreachable now,</div><div class="line">     * and have gc_refs = GC_TENTATIVELY_UNREACHABLE.  All objects to the</div><div class="line">     * left of us in 'young' now have been scanned, and no objects here</div><div class="line">     * or to the right have been scanned yet.</div><div class="line">     */</div><div class="line"></div><div class="line">    while (gc != young) &#123;</div><div class="line">        PyGC_Head *next;</div><div class="line"></div><div class="line">        if (gc-&gt;gc.gc_refs) &#123;</div><div class="line">            /* gc is definitely reachable from outside the</div><div class="line">             * original 'young'.  Mark it as such, and traverse</div><div class="line">             * its pointers to find any other objects that may</div><div class="line">             * be directly reachable from it.  Note that the</div><div class="line">             * call to tp_traverse may append objects to young,</div><div class="line">             * so we have to wait until it returns to determine</div><div class="line">             * the next object to visit.</div><div class="line">             */</div><div class="line">            /* 例如：</div><div class="line">             * list1=[];list2=[list1];list1.append(list2)</div><div class="line">             * del list1;</div><div class="line">             * </div><div class="line">             * 经过subtract_refs后：</div><div class="line">             * list1.gc_refs==0; list2.gc_refs==1</div><div class="line">             * 所以此时的list2有外部的引用，所以是reachable</div><div class="line">             */</div><div class="line">            PyObject *op = FROM_GC(gc);</div><div class="line">            traverseproc traverse = Py_TYPE(op)-&gt;tp_traverse;</div><div class="line">            assert(gc-&gt;gc.gc_refs &gt; 0);</div><div class="line">            gc-&gt;gc.gc_refs = GC_REACHABLE;</div><div class="line">            (void) traverse(op,</div><div class="line">                            (visitproc)visit_reachable,</div><div class="line">                            (void *)young);</div><div class="line">            next = gc-&gt;gc.gc_next;</div><div class="line">            /* 如果对象op中的元素都是untracked的，标记op为untracked */</div><div class="line">            if (PyTuple_CheckExact(op)) &#123;</div><div class="line">                _PyTuple_MaybeUntrack(op);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            /* This *may* be unreachable.  To make progress,</div><div class="line">             * assume it is.  gc isn't directly reachable from</div><div class="line">             * any object we've already traversed, but may be</div><div class="line">             * reachable from an object we haven't gotten to yet.</div><div class="line">             * visit_reachable will eventually move gc back into</div><div class="line">             * young if that's so, and we'll see it again.</div><div class="line">             */</div><div class="line">            /* 代中的对象引用计数为0，说明没有外部引用，可能是unreachable</div><div class="line">             * 如果再作为对象(容器)的元素被visit_reachable处理到</div><div class="line">             * 说明该对象只作为reachable对象的元素，所以也是reachable</div><div class="line">             */</div><div class="line">            next = gc-&gt;gc.gc_next;</div><div class="line">            gc_list_move(gc, unreachable);</div><div class="line">            gc-&gt;gc.gc_refs = GC_TENTATIVELY_UNREACHABLE;</div><div class="line">        &#125;</div><div class="line">        gc = next;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Return true if object has a finalization method.</div><div class="line"> * CAUTION:  An instance of an old-style class has to be checked for a</div><div class="line"> *__del__ method, and earlier versions of this used to call PyObject_HasAttr,</div><div class="line"> * which in turn could call the class's __getattr__ hook (if any).  That</div><div class="line"> * could invoke arbitrary Python code, mutating the object graph in arbitrary</div><div class="line"> * ways, and that was the source of some excruciatingly subtle bugs.</div><div class="line"> */</div><div class="line"></div><div class="line">/*</div><div class="line"> * 有几种自定义析构函数的方式：</div><div class="line"> * 1. 用户类定义了 __del__ 方法</div><div class="line"> * 2. 用户类通过定义 __getattr__ 间接定义了 __del__方法</div><div class="line"> * 3. 生成器定义了 __exit__方法</div><div class="line"> */</div><div class="line"></div><div class="line">static int</div><div class="line">has_finalizer(PyObject *op)</div><div class="line">&#123;</div><div class="line">    if (PyInstance_Check(op)) &#123;</div><div class="line">        assert(delstr != NULL);</div><div class="line">        return _PyInstance_Lookup(op, delstr) != NULL;</div><div class="line">    &#125;</div><div class="line">    else if (PyType_HasFeature(op-&gt;ob_type, Py_TPFLAGS_HEAPTYPE))</div><div class="line">        return op-&gt;ob_type-&gt;tp_del != NULL;</div><div class="line">    else if (PyGen_CheckExact(op))</div><div class="line">        return PyGen_NeedsFinalizing((PyGenObject *)op);</div><div class="line">    else</div><div class="line">        return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Try to untrack all currently tracked dictionaries */</div><div class="line">static void</div><div class="line">untrack_dicts(PyGC_Head *head)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *next, *gc = head-&gt;gc.gc_next;</div><div class="line">    while (gc != head) &#123;</div><div class="line">        PyObject *op = FROM_GC(gc);</div><div class="line">        next = gc-&gt;gc.gc_next;</div><div class="line">        if (PyDict_CheckExact(op))</div><div class="line">            _PyDict_MaybeUntrack(op);</div><div class="line">        gc = next;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">/* unreachable 链表中对象的状态为GC_TENTATIVELY_UNREACHABLE:</div><div class="line"> * 1. 具有 __del__ 方法，移动到 finalizers 链表修改状态为 GC_REACHABLE</div><div class="line"> * 2. 没有 __del__ 方法，保持不变</div><div class="line"> */</div><div class="line">/* Move the objects in unreachable with __del__ methods into `finalizers`.</div><div class="line"> * Objects moved into `finalizers` have gc_refs set to GC_REACHABLE; the</div><div class="line"> * objects remaining in unreachable are left at GC_TENTATIVELY_UNREACHABLE.</div><div class="line"> */</div><div class="line">static void</div><div class="line">move_finalizers(PyGC_Head *unreachable, PyGC_Head *finalizers)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *gc;</div><div class="line">    PyGC_Head *next;</div><div class="line"></div><div class="line">    /* March over unreachable.  Move objects with finalizers into</div><div class="line">     * `finalizers`.</div><div class="line">     */</div><div class="line">    /* 将 unreachable 链表中有析构函数的对象移到 finalizers */</div><div class="line">    for (gc = unreachable-&gt;gc.gc_next; gc != unreachable; gc = next) &#123;</div><div class="line">        PyObject *op = FROM_GC(gc);</div><div class="line"></div><div class="line">        assert(IS_TENTATIVELY_UNREACHABLE(op));</div><div class="line">        next = gc-&gt;gc.gc_next;</div><div class="line"></div><div class="line">        if (has_finalizer(op)) &#123;</div><div class="line">            gc_list_move(gc, finalizers);</div><div class="line">            gc-&gt;gc.gc_refs = GC_REACHABLE;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* A traversal callback for move_finalizer_reachable. */</div><div class="line">static int</div><div class="line">visit_move(PyObject *op, PyGC_Head *tolist)</div><div class="line">&#123;</div><div class="line">    if (PyObject_IS_GC(op)) &#123;</div><div class="line">        if (IS_TENTATIVELY_UNREACHABLE(op)) &#123;</div><div class="line">            PyGC_Head *gc = AS_GC(op);</div><div class="line">            gc_list_move(gc, tolist);</div><div class="line">            gc-&gt;gc.gc_refs = GC_REACHABLE;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Move objects that are reachable from finalizers, from the unreachable set</div><div class="line"> * into finalizers set.</div><div class="line"> */</div><div class="line">/*</div><div class="line"> * 将 finalizers 中的对象设置为 GC_REACHABLE</div><div class="line"> */</div><div class="line">static void</div><div class="line">move_finalizer_reachable(PyGC_Head *finalizers)</div><div class="line">&#123;</div><div class="line">    traverseproc traverse;</div><div class="line">    PyGC_Head *gc = finalizers-&gt;gc.gc_next;</div><div class="line">    for (; gc != finalizers; gc = gc-&gt;gc.gc_next) &#123;</div><div class="line">        /* Note that the finalizers list may grow during this. */</div><div class="line">        traverse = Py_TYPE(FROM_GC(gc))-&gt;tp_traverse;</div><div class="line">        (void) traverse(FROM_GC(gc),</div><div class="line">                        (visitproc)visit_move,</div><div class="line">                        (void *)finalizers);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Clear all weakrefs to unreachable objects, and if such a weakref has a</div><div class="line"> * callback, invoke it if necessary.  Note that it's possible for such</div><div class="line"> * weakrefs to be outside the unreachable set -- indeed, those are precisely</div><div class="line"> * the weakrefs whose callbacks must be invoked.  See gc_weakref.txt for</div><div class="line"> * overview &amp; some details.  Some weakrefs with callbacks may be reclaimed</div><div class="line"> * directly by this routine; the number reclaimed is the return value.  Other</div><div class="line"> * weakrefs with callbacks may be moved into the `old` generation.  Objects</div><div class="line"> * moved into `old` have gc_refs set to GC_REACHABLE; the objects remaining in</div><div class="line"> * unreachable are left at GC_TENTATIVELY_UNREACHABLE.  When this returns,</div><div class="line"> * no object in `unreachable` is weakly referenced anymore.</div><div class="line"> */</div><div class="line">static int</div><div class="line">handle_weakrefs(PyGC_Head *unreachable, PyGC_Head *old)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *gc;</div><div class="line">    PyObject *op;               /* generally FROM_GC(gc) */</div><div class="line">    PyWeakReference *wr;        /* generally a cast of op */</div><div class="line">    PyGC_Head wrcb_to_call;     /* weakrefs with callbacks to call */</div><div class="line">    PyGC_Head *next;</div><div class="line">    int num_freed = 0;</div><div class="line"></div><div class="line">    gc_list_init(&amp;wrcb_to_call);</div><div class="line"></div><div class="line">    /* Clear all weakrefs to the objects in unreachable.  If such a weakref</div><div class="line">     * also has a callback, move it into `wrcb_to_call` if the callback</div><div class="line">     * needs to be invoked.  Note that we cannot invoke any callbacks until</div><div class="line">     * all weakrefs to unreachable objects are cleared, lest the callback</div><div class="line">     * resurrect an unreachable object via a still-active weakref.  We</div><div class="line">     * make another pass over wrcb_to_call, invoking callbacks, after this</div><div class="line">     * pass completes.</div><div class="line">     */</div><div class="line">    for (gc = unreachable-&gt;gc.gc_next; gc != unreachable; gc = next) &#123;</div><div class="line">        PyWeakReference **wrlist;</div><div class="line"></div><div class="line">        op = FROM_GC(gc);</div><div class="line">        assert(IS_TENTATIVELY_UNREACHABLE(op));</div><div class="line">        next = gc-&gt;gc.gc_next;</div><div class="line"></div><div class="line">        if (! PyType_SUPPORTS_WEAKREFS(Py_TYPE(op)))</div><div class="line">            continue;</div><div class="line"></div><div class="line">        /* It supports weakrefs.  Does it have any? */</div><div class="line">        wrlist = (PyWeakReference **)</div><div class="line">                                PyObject_GET_WEAKREFS_LISTPTR(op);</div><div class="line"></div><div class="line">        /* `op` may have some weakrefs.  March over the list, clear</div><div class="line">         * all the weakrefs, and move the weakrefs with callbacks</div><div class="line">         * that must be called into wrcb_to_call.</div><div class="line">         */</div><div class="line">        for (wr = *wrlist; wr != NULL; wr = *wrlist) &#123;</div><div class="line">            PyGC_Head *wrasgc;                  /* AS_GC(wr) */</div><div class="line"></div><div class="line">            /* _PyWeakref_ClearRef clears the weakref but leaves</div><div class="line">             * the callback pointer intact.  Obscure:  it also</div><div class="line">             * changes *wrlist.</div><div class="line">             */</div><div class="line">            assert(wr-&gt;wr_object == op);</div><div class="line">            _PyWeakref_ClearRef(wr);</div><div class="line">            assert(wr-&gt;wr_object == Py_None);</div><div class="line">            if (wr-&gt;wr_callback == NULL)</div><div class="line">                continue;                       /* no callback */</div><div class="line"></div><div class="line">    /* Headache time.  `op` is going away, and is weakly referenced by</div><div class="line">     * `wr`, which has a callback.  Should the callback be invoked?  If wr</div><div class="line">     * is also trash, no:</div><div class="line">     *</div><div class="line">     * 1. There's no need to call it.  The object and the weakref are</div><div class="line">     *    both going away, so it's legitimate to pretend the weakref is</div><div class="line">     *    going away first.  The user has to ensure a weakref outlives its</div><div class="line">     *    referent if they want a guarantee that the wr callback will get</div><div class="line">     *    invoked.</div><div class="line">     *</div><div class="line">     * 2. It may be catastrophic to call it.  If the callback is also in</div><div class="line">     *    cyclic trash (CT), then although the CT is unreachable from</div><div class="line">     *    outside the current generation, CT may be reachable from the</div><div class="line">     *    callback.  Then the callback could resurrect insane objects.</div><div class="line">     *</div><div class="line">     * Since the callback is never needed and may be unsafe in this case,</div><div class="line">     * wr is simply left in the unreachable set.  Note that because we</div><div class="line">     * already called _PyWeakref_ClearRef(wr), its callback will never</div><div class="line">     * trigger.</div><div class="line">     *</div><div class="line">     * OTOH, if wr isn't part of CT, we should invoke the callback:  the</div><div class="line">     * weakref outlived the trash.  Note that since wr isn't CT in this</div><div class="line">     * case, its callback can't be CT either -- wr acted as an external</div><div class="line">     * root to this generation, and therefore its callback did too.  So</div><div class="line">     * nothing in CT is reachable from the callback either, so it's hard</div><div class="line">     * to imagine how calling it later could create a problem for us.  wr</div><div class="line">     * is moved to wrcb_to_call in this case.</div><div class="line">     */</div><div class="line">            if (IS_TENTATIVELY_UNREACHABLE(wr))</div><div class="line">                continue;</div><div class="line">            assert(IS_REACHABLE(wr));</div><div class="line"></div><div class="line">            /* Create a new reference so that wr can't go away</div><div class="line">             * before we can process it again.</div><div class="line">             */</div><div class="line">            Py_INCREF(wr);</div><div class="line"></div><div class="line">            /* Move wr to wrcb_to_call, for the next pass. */</div><div class="line">            wrasgc = AS_GC(wr);</div><div class="line">            assert(wrasgc != next); /* wrasgc is reachable, but</div><div class="line">                                       next isn't, so they can't</div><div class="line">                                       be the same */</div><div class="line">            gc_list_move(wrasgc, &amp;wrcb_to_call);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Invoke the callbacks we decided to honor.  It's safe to invoke them</div><div class="line">     * because they can't reference unreachable objects.</div><div class="line">     */</div><div class="line">    while (! gc_list_is_empty(&amp;wrcb_to_call)) &#123;</div><div class="line">        PyObject *temp;</div><div class="line">        PyObject *callback;</div><div class="line"></div><div class="line">        gc = wrcb_to_call.gc.gc_next;</div><div class="line">        op = FROM_GC(gc);</div><div class="line">        assert(IS_REACHABLE(op));</div><div class="line">        assert(PyWeakref_Check(op));</div><div class="line">        wr = (PyWeakReference *)op;</div><div class="line">        callback = wr-&gt;wr_callback;</div><div class="line">        assert(callback != NULL);</div><div class="line"></div><div class="line">        /* copy-paste of weakrefobject.c's handle_callback() */</div><div class="line">        temp = PyObject_CallFunctionObjArgs(callback, wr, NULL);</div><div class="line">        if (temp == NULL)</div><div class="line">            PyErr_WriteUnraisable(callback);</div><div class="line">        else</div><div class="line">            Py_DECREF(temp);</div><div class="line"></div><div class="line">        /* Give up the reference we created in the first pass.  When</div><div class="line">         * op's refcount hits 0 (which it may or may not do right now),</div><div class="line">         * op's tp_dealloc will decref op-&gt;wr_callback too.  Note</div><div class="line">         * that the refcount probably will hit 0 now, and because this</div><div class="line">         * weakref was reachable to begin with, gc didn't already</div><div class="line">         * add it to its count of freed objects.  Example:  a reachable</div><div class="line">         * weak value dict maps some key to this reachable weakref.</div><div class="line">         * The callback removes this key-&gt;weakref mapping from the</div><div class="line">         * dict, leaving no other references to the weakref (excepting</div><div class="line">         * ours).</div><div class="line">         */</div><div class="line">        Py_DECREF(op);</div><div class="line">        if (wrcb_to_call.gc.gc_next == gc) &#123;</div><div class="line">            /* object is still alive -- move it */</div><div class="line">            gc_list_move(gc, old);</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">            ++num_freed;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return num_freed;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void</div><div class="line">debug_instance(char *msg, PyInstanceObject *inst)</div><div class="line">&#123;</div><div class="line">    char *cname;</div><div class="line">    /* simple version of instance_repr */</div><div class="line">    PyObject *classname = inst-&gt;in_class-&gt;cl_name;</div><div class="line">    if (classname != NULL &amp;&amp; PyString_Check(classname))</div><div class="line">        cname = PyString_AsString(classname);</div><div class="line">    else</div><div class="line">        cname = "?";</div><div class="line">    PySys_WriteStderr("gc: %.100s &lt;%.100s instance at %p&gt;\n",</div><div class="line">                      msg, cname, inst);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void</div><div class="line">debug_cycle(char *msg, PyObject *op)</div><div class="line">&#123;</div><div class="line">    if ((debug &amp; DEBUG_INSTANCES) &amp;&amp; PyInstance_Check(op)) &#123;</div><div class="line">        debug_instance(msg, (PyInstanceObject *)op);</div><div class="line">    &#125;</div><div class="line">    else if (debug &amp; DEBUG_OBJECTS) &#123;</div><div class="line">        PySys_WriteStderr("gc: %.100s &lt;%.100s %p&gt;\n",</div><div class="line">                          msg, Py_TYPE(op)-&gt;tp_name, op);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Handle uncollectable garbage (cycles with finalizers, and stuff reachable</div><div class="line"> * only from such cycles).</div><div class="line"> * If DEBUG_SAVEALL, all objects in finalizers are appended to the module</div><div class="line"> * garbage list (a Python list), else only the objects in finalizers with</div><div class="line"> * __del__ methods are appended to garbage.  All objects in finalizers are</div><div class="line"> * merged into the old list regardless.</div><div class="line"> * Returns 0 if all OK, &lt;0 on error (out of memory to grow the garbage list).</div><div class="line"> * The finalizers list is made empty on a successful return.</div><div class="line"> */</div><div class="line">/*</div><div class="line"> * 将有 finalizer 的对象放入到 garbage</div><div class="line"> * 剩余的 finalizers 中的所有对象放入下一代</div><div class="line"> * 这个时候：</div><div class="line"> * 1. 没有有析构函数的放入 garbage</div><div class="line"> * 2. 有析构函数的放入下一代</div><div class="line"> */</div><div class="line">static int</div><div class="line">handle_finalizers(PyGC_Head *finalizers, PyGC_Head *old)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *gc = finalizers-&gt;gc.gc_next;</div><div class="line"></div><div class="line">    if (garbage == NULL) &#123;</div><div class="line">        garbage = PyList_New(0);</div><div class="line">        if (garbage == NULL)</div><div class="line">            Py_FatalError("gc couldn't create gc.garbage list");</div><div class="line">    &#125;</div><div class="line">    for (; gc != finalizers; gc = gc-&gt;gc.gc_next) &#123;</div><div class="line">        PyObject *op = FROM_GC(gc);</div><div class="line"></div><div class="line">        if ((debug &amp; DEBUG_SAVEALL) || has_finalizer(op)) &#123;</div><div class="line">            if (PyList_Append(garbage, op) &lt; 0)</div><div class="line">                return -1;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    gc_list_merge(finalizers, old);</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Break reference cycles by clearing the containers involved.  This is</div><div class="line"> * tricky business as the lists can be changing and we don't know which</div><div class="line"> * objects may be freed.  It is possible I screwed something up here.</div><div class="line"> */</div><div class="line">/* 回收garbage */</div><div class="line">static void</div><div class="line">delete_garbage(PyGC_Head *collectable, PyGC_Head *old)</div><div class="line">&#123;</div><div class="line">    inquiry clear;</div><div class="line"></div><div class="line">    while (!gc_list_is_empty(collectable)) &#123;</div><div class="line">        PyGC_Head *gc = collectable-&gt;gc.gc_next;</div><div class="line">        PyObject *op = FROM_GC(gc);</div><div class="line"></div><div class="line">        assert(IS_TENTATIVELY_UNREACHABLE(op));</div><div class="line">        if (debug &amp; DEBUG_SAVEALL) &#123;</div><div class="line">            PyList_Append(garbage, op);</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            if ((clear = Py_TYPE(op)-&gt;tp_clear) != NULL) &#123;</div><div class="line">                Py_INCREF(op);</div><div class="line">                clear(op);</div><div class="line">                Py_DECREF(op);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /* clear 函数没有将自己从collectable链表中摘下来</div><div class="line">         * 说明还不能clear，则放入下一代</div><div class="line">         */</div><div class="line">        if (collectable-&gt;gc.gc_next == gc) &#123;</div><div class="line">            /* object is still alive, move it, it may die later */</div><div class="line">            gc_list_move(gc, old);</div><div class="line">            gc-&gt;gc.gc_refs = GC_REACHABLE;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Clear all free lists</div><div class="line"> * All free lists are cleared during the collection of the highest generation.</div><div class="line"> * Allocated items in the free list may keep a pymalloc arena occupied.</div><div class="line"> * Clearing the free lists may give back memory to the OS earlier.</div><div class="line"> */</div><div class="line">/*</div><div class="line"> * 回收没有引用的lists</div><div class="line"> */</div><div class="line">static void</div><div class="line">clear_freelists(void)</div><div class="line">&#123;</div><div class="line">    (void)PyMethod_ClearFreeList();</div><div class="line">    (void)PyFrame_ClearFreeList();</div><div class="line">    (void)PyCFunction_ClearFreeList();</div><div class="line">    (void)PyTuple_ClearFreeList();</div><div class="line">#ifdef Py_USING_UNICODE</div><div class="line">    (void)PyUnicode_ClearFreeList();</div><div class="line">#endif</div><div class="line">    (void)PyInt_ClearFreeList();</div><div class="line">    (void)PyFloat_ClearFreeList();</div><div class="line">&#125;</div><div class="line"></div><div class="line">static double</div><div class="line">get_time(void)</div><div class="line">&#123;</div><div class="line">    double result = 0;</div><div class="line">    if (tmod != NULL) &#123;</div><div class="line">        PyObject *f = PyObject_CallMethod(tmod, "time", NULL);</div><div class="line">        if (f == NULL) &#123;</div><div class="line">            PyErr_Clear();</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            if (PyFloat_Check(f))</div><div class="line">                result = PyFloat_AsDouble(f);</div><div class="line">            Py_DECREF(f);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* This is the main function.  Read this to understand how the</div><div class="line"> * collection process works. */</div><div class="line">static Py_ssize_t</div><div class="line">collect(int generation)</div><div class="line">&#123;</div><div class="line">    int i;</div><div class="line">    Py_ssize_t m = 0; /* # objects collected */</div><div class="line">    Py_ssize_t n = 0; /* # unreachable objects that couldn't be collected */</div><div class="line">    PyGC_Head *young; /* the generation we are examining */</div><div class="line">    PyGC_Head *old; /* next older generation */</div><div class="line">    PyGC_Head unreachable; /* non-problematic unreachable trash */</div><div class="line">    PyGC_Head finalizers;  /* objects with, &amp; reachable from, __del__ */</div><div class="line">    PyGC_Head *gc;</div><div class="line">    double t1 = 0.0;</div><div class="line"></div><div class="line">    if (delstr == NULL) &#123;</div><div class="line">        delstr = PyString_InternFromString("__del__");</div><div class="line">        if (delstr == NULL)</div><div class="line">            Py_FatalError("gc couldn't allocate \"__del__\"");</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (debug &amp; DEBUG_STATS) &#123;</div><div class="line">        PySys_WriteStderr("gc: collecting generation %d...\n",</div><div class="line">                          generation);</div><div class="line">        PySys_WriteStderr("gc: objects in each generation:");</div><div class="line">        for (i = 0; i &lt; NUM_GENERATIONS; i++)</div><div class="line">            PySys_WriteStderr(" %" PY_FORMAT_SIZE_T "d",</div><div class="line">                              gc_list_size(GEN_HEAD(i)));</div><div class="line">        t1 = get_time();</div><div class="line">        PySys_WriteStderr("\n");</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* update collection and allocation counters */</div><div class="line">    /* 递增老一代的年龄 */</div><div class="line">    if (generation+1 &lt; NUM_GENERATIONS)</div><div class="line">        generations[generation+1].count += 1;</div><div class="line">    /* 年轻的所有代都归零，因为会处理所有年轻代的对象*/</div><div class="line">    for (i = 0; i &lt;= generation; i++)</div><div class="line">        generations[i].count = 0;</div><div class="line"></div><div class="line">    /* merge younger generations with one we are currently collecting */</div><div class="line">    /* 收集第3代，则将第1,2代的对象都加入到第3代中 */</div><div class="line">    for (i = 0; i &lt; generation; i++) &#123;</div><div class="line">        gc_list_merge(GEN_HEAD(i), GEN_HEAD(generation));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* handy references */</div><div class="line">    young = GEN_HEAD(generation);</div><div class="line">    if (generation &lt; NUM_GENERATIONS-1)</div><div class="line">        old = GEN_HEAD(generation+1);</div><div class="line">    else</div><div class="line">        old = young;</div><div class="line"></div><div class="line">    /* Using ob_refcnt and gc_refs, calculate which objects in the</div><div class="line">     * container set are reachable from outside the set (i.e., have a</div><div class="line">     * refcount greater than 0 when all the references within the</div><div class="line">     * set are taken into account).</div><div class="line">     */</div><div class="line">    /* 将当前代的对象的引用计数复制到gc_refs=ob_refcnt */</div><div class="line">    update_refs(young);</div><div class="line">    </div><div class="line">    /* 将本代的所有容器内的元素gc_refs-1 */</div><div class="line">    subtract_refs(young);</div><div class="line"></div><div class="line">    /* Leave everything reachable from outside young in young, and move</div><div class="line">     * everything else (in young) to unreachable.</div><div class="line">     * NOTE:  This used to move the reachable objects into a reachable</div><div class="line">     * set instead.  But most things usually turn out to be reachable,</div><div class="line">     * so it's more efficient to move the unreachable things.</div><div class="line">     */</div><div class="line">    /* 将unreachable的容器放入unreachable链表中 */</div><div class="line">    gc_list_init(&amp;unreachable);</div><div class="line">    move_unreachable(young, &amp;unreachable);</div><div class="line"></div><div class="line">    /* Move reachable objects to next generation. */</div><div class="line">    /* 将剩余的reachable的容器放入老一代中 </div><div class="line">     * 如果当前是第2代，则累计long_lived_pending</div><div class="line">     */</div><div class="line">    if (young != old) &#123;</div><div class="line">        if (generation == NUM_GENERATIONS - 2) &#123;</div><div class="line">            long_lived_pending += gc_list_size(young);</div><div class="line">        &#125;</div><div class="line">        gc_list_merge(young, old);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        /* We only untrack dicts in full collections, to avoid quadratic</div><div class="line">           dict build-up. See issue #14775. */</div><div class="line">        untrack_dicts(young);</div><div class="line">        long_lived_pending = 0;</div><div class="line">        long_lived_total = gc_list_size(young);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* All objects in unreachable are trash, but objects reachable from</div><div class="line">     * finalizers can't safely be deleted.  Python programmers should take</div><div class="line">     * care not to create such things.  For Python, finalizers means</div><div class="line">     * instance objects with __del__ methods.  Weakrefs with callbacks</div><div class="line">     * can also call arbitrary Python code but they will be dealt with by</div><div class="line">     * handle_weakrefs().</div><div class="line">     */</div><div class="line">    /*</div><div class="line">     * unreachable中有析构函数的不能直接清除，所以需要移动到finalizers</div><div class="line">     * 将finalizers中的容器中的元素标记为reachable</div><div class="line">     */</div><div class="line">    gc_list_init(&amp;finalizers);</div><div class="line">    move_finalizers(&amp;unreachable, &amp;finalizers);</div><div class="line">    /* finalizers contains the unreachable objects with a finalizer;</div><div class="line">     * unreachable objects reachable *from* those are also uncollectable,</div><div class="line">     * and we move those into the finalizers list too.</div><div class="line">     */</div><div class="line">    /*</div><div class="line">     * finalizers中的对象中的元素也需要加入到finalizers，例如</div><div class="line">     * a = 0; class Test(object): def __del__(self): a; del a</div><div class="line">     * 如果Test是unreachable，那么a即使是reachable也不能被收集，</div><div class="line">     * 所以需要把其也加入到finalizers</div><div class="line">     */</div><div class="line">    move_finalizer_reachable(&amp;finalizers);</div><div class="line"></div><div class="line">    /* Collect statistics on collectable objects found and print</div><div class="line">     * debugging information.</div><div class="line">     */</div><div class="line">    for (gc = unreachable.gc.gc_next; gc != &amp;unreachable;</div><div class="line">                    gc = gc-&gt;gc.gc_next) &#123;</div><div class="line">        m++;</div><div class="line">        if (debug &amp; DEBUG_COLLECTABLE) &#123;</div><div class="line">            debug_cycle("collectable", FROM_GC(gc));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Clear weakrefs and invoke callbacks as necessary. */</div><div class="line">    m += handle_weakrefs(&amp;unreachable, old);</div><div class="line"></div><div class="line">    /* Call tp_clear on objects in the unreachable set.  This will cause</div><div class="line">     * the reference cycles to be broken.  It may also cause some objects</div><div class="line">     * in finalizers to be freed.</div><div class="line">     */</div><div class="line">    /* 清除可以清除的；把不能清除的放入老一代 */</div><div class="line">    delete_garbage(&amp;unreachable, old);</div><div class="line"></div><div class="line">    /* Collect statistics on uncollectable objects found and print</div><div class="line">     * debugging information. */</div><div class="line">    for (gc = finalizers.gc.gc_next;</div><div class="line">         gc != &amp;finalizers;</div><div class="line">         gc = gc-&gt;gc.gc_next) &#123;</div><div class="line">        n++;</div><div class="line">        if (debug &amp; DEBUG_UNCOLLECTABLE)</div><div class="line">            debug_cycle("uncollectable", FROM_GC(gc));</div><div class="line">    &#125;</div><div class="line">    if (debug &amp; DEBUG_STATS) &#123;</div><div class="line">        double t2 = get_time();</div><div class="line">        if (m == 0 &amp;&amp; n == 0)</div><div class="line">            PySys_WriteStderr("gc: done");</div><div class="line">        else</div><div class="line">            PySys_WriteStderr(</div><div class="line">                "gc: done, "</div><div class="line">                "%" PY_FORMAT_SIZE_T "d unreachable, "</div><div class="line">                "%" PY_FORMAT_SIZE_T "d uncollectable",</div><div class="line">                n+m, n);</div><div class="line">        if (t1 &amp;&amp; t2) &#123;</div><div class="line">            PySys_WriteStderr(", %.4fs elapsed", t2-t1);</div><div class="line">        &#125;</div><div class="line">        PySys_WriteStderr(".\n");</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /* Append instances in the uncollectable set to a Python</div><div class="line">     * reachable list of garbage.  The programmer has to deal with</div><div class="line">     * this if they insist on creating this type of structure.</div><div class="line">     */</div><div class="line">    /*</div><div class="line">     * 所以如果析构函数中有循环引用，那么可能永远不可能被清除</div><div class="line">     */</div><div class="line">    (void)handle_finalizers(&amp;finalizers, old);</div><div class="line"></div><div class="line">    /* Clear free list only during the collection of the highest</div><div class="line">     * generation */</div><div class="line">    if (generation == NUM_GENERATIONS-1) &#123;</div><div class="line">        clear_freelists();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (PyErr_Occurred()) &#123;</div><div class="line">        if (gc_str == NULL)</div><div class="line">            gc_str = PyString_FromString("garbage collection");</div><div class="line">        PyErr_WriteUnraisable(gc_str);</div><div class="line">        Py_FatalError("unexpected exception during garbage collection");</div><div class="line">    &#125;</div><div class="line">    return n+m;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static Py_ssize_t</div><div class="line">collect_generations(void)</div><div class="line">&#123;</div><div class="line">    int i;</div><div class="line">    Py_ssize_t n = 0;</div><div class="line"></div><div class="line">    /* Find the oldest generation (highest numbered) where the count</div><div class="line">     * exceeds the threshold.  Objects in the that generation and</div><div class="line">     * generations younger than it will be collected. */</div><div class="line">    /*</div><div class="line">     * 垃圾回收的规则：</div><div class="line">     * 1. 每代的寿命到了才启动该代的垃圾回收(count&gt;threshold)</div><div class="line">     *    (第一代的寿命作为启动垃圾回收的入口)</div><div class="line">     * 2. 每代运行一次，则老一代年龄增长一岁</div><div class="line">     * 4. 每代运行时，处理所有比其年轻的代的对象</div><div class="line">     */ </div><div class="line">    for (i = NUM_GENERATIONS-1; i &gt;= 0; i--) &#123;</div><div class="line">        if (generations[i].count &gt; generations[i].threshold) &#123;</div><div class="line">            /* Avoid quadratic performance degradation in number</div><div class="line">               of tracked objects. See comments at the beginning</div><div class="line">               of this file, and issue #4074.</div><div class="line">            */</div><div class="line">            /* long_lived_pending:</div><div class="line">             * 在运行第三代收集之前，从第二代放入第三代的对象个数</div><div class="line">             * long_lived_total:</div><div class="line">             * 在运行第三代收集时，第三代中不能回收的对象个数</div><div class="line">             *</div><div class="line">             * 简单来说：第三代中新增加的对象数量大于25%才运行</div><div class="line">             */</div><div class="line">            if (i == NUM_GENERATIONS - 1</div><div class="line">                &amp;&amp; long_lived_pending &lt; long_lived_total / 4)</div><div class="line">                continue;</div><div class="line">            n = collect(i);</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return n;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_enable__doc__,</div><div class="line">"enable() -&gt; None\n"</div><div class="line">"\n"</div><div class="line">"Enable automatic garbage collection.\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_enable(PyObject *self, PyObject *noargs)</div><div class="line">&#123;</div><div class="line">    enabled = 1;</div><div class="line">    Py_INCREF(Py_None);</div><div class="line">    return Py_None;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_disable__doc__,</div><div class="line">"disable() -&gt; None\n"</div><div class="line">"\n"</div><div class="line">"Disable automatic garbage collection.\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_disable(PyObject *self, PyObject *noargs)</div><div class="line">&#123;</div><div class="line">    enabled = 0;</div><div class="line">    Py_INCREF(Py_None);</div><div class="line">    return Py_None;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_isenabled__doc__,</div><div class="line">"isenabled() -&gt; status\n"</div><div class="line">"\n"</div><div class="line">"Returns true if automatic garbage collection is enabled.\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_isenabled(PyObject *self, PyObject *noargs)</div><div class="line">&#123;</div><div class="line">    return PyBool_FromLong((long)enabled);</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_collect__doc__,</div><div class="line">"collect([generation]) -&gt; n\n"</div><div class="line">"\n"</div><div class="line">"With no arguments, run a full collection.  The optional argument\n"</div><div class="line">"may be an integer specifying which generation to collect.  A ValueError\n"</div><div class="line">"is raised if the generation number is invalid.\n\n"</div><div class="line">"The number of unreachable objects is returned.\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_collect(PyObject *self, PyObject *args, PyObject *kws)</div><div class="line">&#123;</div><div class="line">    static char *keywords[] = &#123;"generation", NULL&#125;;</div><div class="line">    int genarg = NUM_GENERATIONS - 1;</div><div class="line">    Py_ssize_t n;</div><div class="line"></div><div class="line">    if (!PyArg_ParseTupleAndKeywords(args, kws, "|i", keywords, &amp;genarg))</div><div class="line">        return NULL;</div><div class="line"></div><div class="line">    else if (genarg &lt; 0 || genarg &gt;= NUM_GENERATIONS) &#123;</div><div class="line">        PyErr_SetString(PyExc_ValueError, "invalid generation");</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (collecting)</div><div class="line">        n = 0; /* already collecting, don't do anything */</div><div class="line">    else &#123;</div><div class="line">        collecting = 1;</div><div class="line">        n = collect(genarg);</div><div class="line">        collecting = 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return PyInt_FromSsize_t(n);</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_set_debug__doc__,</div><div class="line">"set_debug(flags) -&gt; None\n"</div><div class="line">"\n"</div><div class="line">"Set the garbage collection debugging flags. Debugging information is\n"</div><div class="line">"written to sys.stderr.\n"</div><div class="line">"\n"</div><div class="line">"flags is an integer and can have the following bits turned on:\n"</div><div class="line">"\n"</div><div class="line">"  DEBUG_STATS - Print statistics during collection.\n"</div><div class="line">"  DEBUG_COLLECTABLE - Print collectable objects found.\n"</div><div class="line">"  DEBUG_UNCOLLECTABLE - Print unreachable but uncollectable objects found.\n"</div><div class="line">"  DEBUG_INSTANCES - Print instance objects.\n"</div><div class="line">"  DEBUG_OBJECTS - Print objects other than instances.\n"</div><div class="line">"  DEBUG_SAVEALL - Save objects to gc.garbage rather than freeing them.\n"</div><div class="line">"  DEBUG_LEAK - Debug leaking programs (everything but STATS).\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_set_debug(PyObject *self, PyObject *args)</div><div class="line">&#123;</div><div class="line">    if (!PyArg_ParseTuple(args, "i:set_debug", &amp;debug))</div><div class="line">        return NULL;</div><div class="line"></div><div class="line">    Py_INCREF(Py_None);</div><div class="line">    return Py_None;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_get_debug__doc__,</div><div class="line">"get_debug() -&gt; flags\n"</div><div class="line">"\n"</div><div class="line">"Get the garbage collection debugging flags.\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_get_debug(PyObject *self, PyObject *noargs)</div><div class="line">&#123;</div><div class="line">    return Py_BuildValue("i", debug);</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_set_thresh__doc__,</div><div class="line">"set_threshold(threshold0, [threshold1, threshold2]) -&gt; None\n"</div><div class="line">"\n"</div><div class="line">"Sets the collection thresholds.  Setting threshold0 to zero disables\n"</div><div class="line">"collection.\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_set_thresh(PyObject *self, PyObject *args)</div><div class="line">&#123;</div><div class="line">    int i;</div><div class="line">    if (!PyArg_ParseTuple(args, "i|ii:set_threshold",</div><div class="line">                          &amp;generations[0].threshold,</div><div class="line">                          &amp;generations[1].threshold,</div><div class="line">                          &amp;generations[2].threshold))</div><div class="line">        return NULL;</div><div class="line">    for (i = 2; i &lt; NUM_GENERATIONS; i++) &#123;</div><div class="line">        /* generations higher than 2 get the same threshold */</div><div class="line">        generations[i].threshold = generations[2].threshold;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Py_INCREF(Py_None);</div><div class="line">    return Py_None;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_get_thresh__doc__,</div><div class="line">"get_threshold() -&gt; (threshold0, threshold1, threshold2)\n"</div><div class="line">"\n"</div><div class="line">"Return the current collection thresholds\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_get_thresh(PyObject *self, PyObject *noargs)</div><div class="line">&#123;</div><div class="line">    return Py_BuildValue("(iii)",</div><div class="line">                         generations[0].threshold,</div><div class="line">                         generations[1].threshold,</div><div class="line">                         generations[2].threshold);</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_get_count__doc__,</div><div class="line">"get_count() -&gt; (count0, count1, count2)\n"</div><div class="line">"\n"</div><div class="line">"Return the current collection counts\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_get_count(PyObject *self, PyObject *noargs)</div><div class="line">&#123;</div><div class="line">    return Py_BuildValue("(iii)",</div><div class="line">                         generations[0].count,</div><div class="line">                         generations[1].count,</div><div class="line">                         generations[2].count);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static int</div><div class="line">referrersvisit(PyObject* obj, PyObject *objs)</div><div class="line">&#123;</div><div class="line">    Py_ssize_t i;</div><div class="line">    for (i = 0; i &lt; PyTuple_GET_SIZE(objs); i++)</div><div class="line">        if (PyTuple_GET_ITEM(objs, i) == obj)</div><div class="line">            return 1;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static int</div><div class="line">gc_referrers_for(PyObject *objs, PyGC_Head *list, PyObject *resultlist)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *gc;</div><div class="line">    PyObject *obj;</div><div class="line">    traverseproc traverse;</div><div class="line">    for (gc = list-&gt;gc.gc_next; gc != list; gc = gc-&gt;gc.gc_next) &#123;</div><div class="line">        obj = FROM_GC(gc);</div><div class="line">        traverse = Py_TYPE(obj)-&gt;tp_traverse;</div><div class="line">        if (obj == objs || obj == resultlist)</div><div class="line">            continue;</div><div class="line">        if (traverse(obj, (visitproc)referrersvisit, objs)) &#123;</div><div class="line">            if (PyList_Append(resultlist, obj) &lt; 0)</div><div class="line">                return 0; /* error */</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return 1; /* no error */</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_get_referrers__doc__,</div><div class="line">"get_referrers(*objs) -&gt; list\n\</div><div class="line">Return the list of objects that directly refer to any of objs.");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_get_referrers(PyObject *self, PyObject *args)</div><div class="line">&#123;</div><div class="line">    int i;</div><div class="line">    PyObject *result = PyList_New(0);</div><div class="line">    if (!result) return NULL;</div><div class="line"></div><div class="line">    for (i = 0; i &lt; NUM_GENERATIONS; i++) &#123;</div><div class="line">        if (!(gc_referrers_for(args, GEN_HEAD(i), result))) &#123;</div><div class="line">            Py_DECREF(result);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* Append obj to list; return true if error (out of memory), false if OK. */</div><div class="line">static int</div><div class="line">referentsvisit(PyObject *obj, PyObject *list)</div><div class="line">&#123;</div><div class="line">    return PyList_Append(list, obj) &lt; 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_get_referents__doc__,</div><div class="line">"get_referents(*objs) -&gt; list\n\</div><div class="line">Return the list of objects that are directly referred to by objs.");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_get_referents(PyObject *self, PyObject *args)</div><div class="line">&#123;</div><div class="line">    Py_ssize_t i;</div><div class="line">    PyObject *result = PyList_New(0);</div><div class="line"></div><div class="line">    if (result == NULL)</div><div class="line">        return NULL;</div><div class="line"></div><div class="line">    for (i = 0; i &lt; PyTuple_GET_SIZE(args); i++) &#123;</div><div class="line">        traverseproc traverse;</div><div class="line">        PyObject *obj = PyTuple_GET_ITEM(args, i);</div><div class="line"></div><div class="line">        if (! PyObject_IS_GC(obj))</div><div class="line">            continue;</div><div class="line">        traverse = Py_TYPE(obj)-&gt;tp_traverse;</div><div class="line">        if (! traverse)</div><div class="line">            continue;</div><div class="line">        if (traverse(obj, (visitproc)referentsvisit, result)) &#123;</div><div class="line">            Py_DECREF(result);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_get_objects__doc__,</div><div class="line">"get_objects() -&gt; [...]\n"</div><div class="line">"\n"</div><div class="line">"Return a list of objects tracked by the collector (excluding the list\n"</div><div class="line">"returned).\n");</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_get_objects(PyObject *self, PyObject *noargs)</div><div class="line">&#123;</div><div class="line">    int i;</div><div class="line">    PyObject* result;</div><div class="line"></div><div class="line">    result = PyList_New(0);</div><div class="line">    if (result == NULL)</div><div class="line">        return NULL;</div><div class="line">    for (i = 0; i &lt; NUM_GENERATIONS; i++) &#123;</div><div class="line">        if (append_objects(result, GEN_HEAD(i))) &#123;</div><div class="line">            Py_DECREF(result);</div><div class="line">            return NULL;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyDoc_STRVAR(gc_is_tracked__doc__,</div><div class="line">"is_tracked(obj) -&gt; bool\n"</div><div class="line">"\n"</div><div class="line">"Returns true if the object is tracked by the garbage collector.\n"</div><div class="line">"Simple atomic objects will return false.\n"</div><div class="line">);</div><div class="line"></div><div class="line">static PyObject *</div><div class="line">gc_is_tracked(PyObject *self, PyObject *obj)</div><div class="line">&#123;</div><div class="line">    PyObject *result;</div><div class="line"></div><div class="line">    if (PyObject_IS_GC(obj) &amp;&amp; IS_TRACKED(obj))</div><div class="line">        result = Py_True;</div><div class="line">    else</div><div class="line">        result = Py_False;</div><div class="line">    Py_INCREF(result);</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">PyDoc_STRVAR(gc__doc__,</div><div class="line">"This module provides access to the garbage collector for reference cycles.\n"</div><div class="line">"\n"</div><div class="line">"enable() -- Enable automatic garbage collection.\n"</div><div class="line">"disable() -- Disable automatic garbage collection.\n"</div><div class="line">"isenabled() -- Returns true if automatic collection is enabled.\n"</div><div class="line">"collect() -- Do a full collection right now.\n"</div><div class="line">"get_count() -- Return the current collection counts.\n"</div><div class="line">"set_debug() -- Set debugging flags.\n"</div><div class="line">"get_debug() -- Get debugging flags.\n"</div><div class="line">"set_threshold() -- Set the collection thresholds.\n"</div><div class="line">"get_threshold() -- Return the current the collection thresholds.\n"</div><div class="line">"get_objects() -- Return a list of all objects tracked by the collector.\n"</div><div class="line">"is_tracked() -- Returns true if a given object is tracked.\n"</div><div class="line">"get_referrers() -- Return the list of objects that refer to an object.\n"</div><div class="line">"get_referents() -- Return the list of objects that an object refers to.\n");</div><div class="line"></div><div class="line">static PyMethodDef GcMethods[] = &#123;</div><div class="line">    &#123;"enable",             gc_enable,     METH_NOARGS,  gc_enable__doc__&#125;,</div><div class="line">    &#123;"disable",            gc_disable,    METH_NOARGS,  gc_disable__doc__&#125;,</div><div class="line">    &#123;"isenabled",          gc_isenabled,  METH_NOARGS,  gc_isenabled__doc__&#125;,</div><div class="line">    &#123;"set_debug",          gc_set_debug,  METH_VARARGS, gc_set_debug__doc__&#125;,</div><div class="line">    &#123;"get_debug",          gc_get_debug,  METH_NOARGS,  gc_get_debug__doc__&#125;,</div><div class="line">    &#123;"get_count",          gc_get_count,  METH_NOARGS,  gc_get_count__doc__&#125;,</div><div class="line">    &#123;"set_threshold",  gc_set_thresh, METH_VARARGS, gc_set_thresh__doc__&#125;,</div><div class="line">    &#123;"get_threshold",  gc_get_thresh, METH_NOARGS,  gc_get_thresh__doc__&#125;,</div><div class="line">    &#123;"collect",            (PyCFunction)gc_collect,</div><div class="line">        METH_VARARGS | METH_KEYWORDS,           gc_collect__doc__&#125;,</div><div class="line">    &#123;"get_objects",    gc_get_objects,METH_NOARGS,  gc_get_objects__doc__&#125;,</div><div class="line">    &#123;"is_tracked",     gc_is_tracked, METH_O,       gc_is_tracked__doc__&#125;,</div><div class="line">    &#123;"get_referrers",  gc_get_referrers, METH_VARARGS,</div><div class="line">        gc_get_referrers__doc__&#125;,</div><div class="line">    &#123;"get_referents",  gc_get_referents, METH_VARARGS,</div><div class="line">        gc_get_referents__doc__&#125;,</div><div class="line">    &#123;NULL,      NULL&#125;           /* Sentinel */</div><div class="line">&#125;;</div><div class="line"></div><div class="line">PyMODINIT_FUNC</div><div class="line">initgc(void)</div><div class="line">&#123;</div><div class="line">    PyObject *m;</div><div class="line"></div><div class="line">    m = Py_InitModule4("gc",</div><div class="line">                          GcMethods,</div><div class="line">                          gc__doc__,</div><div class="line">                          NULL,</div><div class="line">                          PYTHON_API_VERSION);</div><div class="line">    if (m == NULL)</div><div class="line">        return;</div><div class="line"></div><div class="line">    if (garbage == NULL) &#123;</div><div class="line">        garbage = PyList_New(0);</div><div class="line">        if (garbage == NULL)</div><div class="line">            return;</div><div class="line">    &#125;</div><div class="line">    Py_INCREF(garbage);</div><div class="line">    if (PyModule_AddObject(m, "garbage", garbage) &lt; 0)</div><div class="line">        return;</div><div class="line"></div><div class="line">    /* Importing can't be done in collect() because collect()</div><div class="line">     * can be called via PyGC_Collect() in Py_Finalize().</div><div class="line">     * This wouldn't be a problem, except that &lt;initialized&gt; is</div><div class="line">     * reset to 0 before calling collect which trips up</div><div class="line">     * the import and triggers an assertion.</div><div class="line">     */</div><div class="line">    if (tmod == NULL) &#123;</div><div class="line">        tmod = PyImport_ImportModuleNoBlock("time");</div><div class="line">        if (tmod == NULL)</div><div class="line">            PyErr_Clear();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">#define ADD_INT(NAME) if (PyModule_AddIntConstant(m, #NAME, NAME) &lt; 0) return</div><div class="line">    ADD_INT(DEBUG_STATS);</div><div class="line">    ADD_INT(DEBUG_COLLECTABLE);</div><div class="line">    ADD_INT(DEBUG_UNCOLLECTABLE);</div><div class="line">    ADD_INT(DEBUG_INSTANCES);</div><div class="line">    ADD_INT(DEBUG_OBJECTS);</div><div class="line">    ADD_INT(DEBUG_SAVEALL);</div><div class="line">    ADD_INT(DEBUG_LEAK);</div><div class="line">#undef ADD_INT</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* API to invoke gc.collect() from C */</div><div class="line">Py_ssize_t</div><div class="line">PyGC_Collect(void)</div><div class="line">&#123;</div><div class="line">    Py_ssize_t n;</div><div class="line"></div><div class="line">    if (collecting)</div><div class="line">        n = 0; /* already collecting, don't do anything */</div><div class="line">    else &#123;</div><div class="line">        collecting = 1;</div><div class="line">        n = collect(NUM_GENERATIONS - 1);</div><div class="line">        collecting = 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return n;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* for debugging */</div><div class="line">void</div><div class="line">_PyGC_Dump(PyGC_Head *g)</div><div class="line">&#123;</div><div class="line">    _PyObject_Dump(FROM_GC(g));</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* extension modules might be compiled with GC support so these</div><div class="line">   functions must always be available */</div><div class="line"></div><div class="line">#undef PyObject_GC_Track</div><div class="line">#undef PyObject_GC_UnTrack</div><div class="line">#undef PyObject_GC_Del</div><div class="line">#undef _PyObject_GC_Malloc</div><div class="line"></div><div class="line">void</div><div class="line">PyObject_GC_Track(void *op)</div><div class="line">&#123;</div><div class="line">    _PyObject_GC_TRACK(op);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* for binary compatibility with 2.2 */</div><div class="line">void</div><div class="line">_PyObject_GC_Track(PyObject *op)</div><div class="line">&#123;</div><div class="line">    PyObject_GC_Track(op);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">PyObject_GC_UnTrack(void *op)</div><div class="line">&#123;</div><div class="line">    /* Obscure:  the Py_TRASHCAN mechanism requires that we be able to</div><div class="line">     * call PyObject_GC_UnTrack twice on an object.</div><div class="line">     */</div><div class="line">    if (IS_TRACKED(op))</div><div class="line">        _PyObject_GC_UNTRACK(op);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* for binary compatibility with 2.2 */</div><div class="line">void</div><div class="line">_PyObject_GC_UnTrack(PyObject *op)</div><div class="line">&#123;</div><div class="line">    PyObject_GC_UnTrack(op);</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyObject *</div><div class="line">_PyObject_GC_Malloc(size_t basicsize)</div><div class="line">&#123;</div><div class="line">    PyObject *op;</div><div class="line">    PyGC_Head *g;</div><div class="line">    if (basicsize &gt; PY_SSIZE_T_MAX - sizeof(PyGC_Head))</div><div class="line">        return PyErr_NoMemory();</div><div class="line">    g = (PyGC_Head *)PyObject_MALLOC(</div><div class="line">        sizeof(PyGC_Head) + basicsize);</div><div class="line">    if (g == NULL)</div><div class="line">        return PyErr_NoMemory();</div><div class="line">    g-&gt;gc.gc_refs = GC_UNTRACKED;</div><div class="line">    /* 分配的PyObject &gt; 700 就执行垃圾回收 */</div><div class="line">    generations[0].count++; /* number of allocated GC objects */</div><div class="line">    if (generations[0].count &gt; generations[0].threshold &amp;&amp;</div><div class="line">        enabled &amp;&amp;</div><div class="line">        generations[0].threshold &amp;&amp;</div><div class="line">        !collecting &amp;&amp;</div><div class="line">        !PyErr_Occurred()) &#123;</div><div class="line">        collecting = 1;</div><div class="line">        collect_generations();</div><div class="line">        collecting = 0;</div><div class="line">    &#125;</div><div class="line">    op = FROM_GC(g);</div><div class="line">    return op;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyObject *</div><div class="line">_PyObject_GC_New(PyTypeObject *tp)</div><div class="line">&#123;</div><div class="line">    PyObject *op = _PyObject_GC_Malloc(_PyObject_SIZE(tp));</div><div class="line">    if (op != NULL)</div><div class="line">        op = PyObject_INIT(op, tp);</div><div class="line">    return op;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyVarObject *</div><div class="line">_PyObject_GC_NewVar(PyTypeObject *tp, Py_ssize_t nitems)</div><div class="line">&#123;</div><div class="line">    const size_t size = _PyObject_VAR_SIZE(tp, nitems);</div><div class="line">    PyVarObject *op = (PyVarObject *) _PyObject_GC_Malloc(size);</div><div class="line">    if (op != NULL)</div><div class="line">        op = PyObject_INIT_VAR(op, tp, nitems);</div><div class="line">    return op;</div><div class="line">&#125;</div><div class="line"></div><div class="line">PyVarObject *</div><div class="line">_PyObject_GC_Resize(PyVarObject *op, Py_ssize_t nitems)</div><div class="line">&#123;</div><div class="line">    const size_t basicsize = _PyObject_VAR_SIZE(Py_TYPE(op), nitems);</div><div class="line">    PyGC_Head *g = AS_GC(op);</div><div class="line">    if (basicsize &gt; PY_SSIZE_T_MAX - sizeof(PyGC_Head))</div><div class="line">        return (PyVarObject *)PyErr_NoMemory();</div><div class="line">    g = (PyGC_Head *)PyObject_REALLOC(g,  sizeof(PyGC_Head) + basicsize);</div><div class="line">    if (g == NULL)</div><div class="line">        return (PyVarObject *)PyErr_NoMemory();</div><div class="line">    op = (PyVarObject *) FROM_GC(g);</div><div class="line">    Py_SIZE(op) = nitems;</div><div class="line">    return op;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">PyObject_GC_Del(void *op)</div><div class="line">&#123;</div><div class="line">    PyGC_Head *g = AS_GC(op);</div><div class="line">    if (IS_TRACKED(op))</div><div class="line">        gc_list_remove(g);</div><div class="line">    if (generations[0].count &gt; 0) &#123;</div><div class="line">        generations[0].count--;</div><div class="line">    &#125;</div><div class="line">    PyObject_FREE(g);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/* for binary compatibility with 2.2 */</div><div class="line">#undef _PyObject_GC_Del</div><div class="line">void</div><div class="line">_PyObject_GC_Del(PyObject *op)</div><div class="line">&#123;</div><div class="line">    PyObject_GC_Del(op);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2016/10/09/python-obmalloc/" rel="next" title="Python源码剖析—统一内存管理">
                <i class="fa fa-chevron-left"></i> Python源码剖析—统一内存管理
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2016/10/17/python-int/" rel="prev" title="Python源码剖析—整数对象PyIntObject">
                Python源码剖析—整数对象PyIntObject <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/10/11/python-gc/"
           data-title="Python源码剖析—循环垃圾回收器" data-url="http://fanchao01.github.io/blog/blog/2016/10/11/python-gc/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/blog/images/avatar.gif"
               alt="FanChao" />
          <p class="site-author-name" itemprop="name">FanChao</p>
          <p class="site-description motion-element" itemprop="description">Enjoin it!</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">36</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/blog/categories">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/blog/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Python垃圾回收概述"><span class="nav-number">1.</span> <span class="nav-text">Python垃圾回收概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#循环垃圾收集器的原理"><span class="nav-number">2.</span> <span class="nav-text">循环垃圾收集器的原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#垃圾对象不一定能被自动回收"><span class="nav-number">3.</span> <span class="nav-text">垃圾对象不一定能被自动回收</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#不是所有对象都纳入循环垃圾收集器"><span class="nav-number">4.</span> <span class="nav-text">不是所有对象都纳入循环垃圾收集器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#垃圾回收中的代"><span class="nav-number">5.</span> <span class="nav-text">垃圾回收中的代</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gcmodule-c源码分析"><span class="nav-number">6.</span> <span class="nav-text">gcmodule.c源码分析</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FanChao</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"fanchao01"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
