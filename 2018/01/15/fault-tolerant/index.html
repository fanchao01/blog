<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/blog/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/blog/atom.xml" title="Blog My Minds" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico?v=5.0.1" />






<meta name="description" content="一些在容错方面的想法、思考点和方向。容错，高可用，容灾，fault-tolerant">
<meta property="og:type" content="article">
<meta property="og:title" content="一些容错方面的思考">
<meta property="og:url" content="http://fanchao01.github.io/blog/2018/01/15/fault-tolerant/index.html">
<meta property="og:site_name" content="Blog My Minds">
<meta property="og:description" content="一些在容错方面的想法、思考点和方向。容错，高可用，容灾，fault-tolerant">
<meta property="og:image" content="http://fanchao01.github.io/blog/blog/images/ha.png">
<meta property="og:image" content="http://fanchao01.github.io/blog/blog/images/unplanned_downtime.png">
<meta property="og:image" content="http://fanchao01.github.io/blog/blog/images/planned_downtime.png">
<meta property="og:updated_time" content="2018-01-31T04:15:37.448Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一些容错方面的思考">
<meta name="twitter:description" content="一些在容错方面的想法、思考点和方向。容错，高可用，容灾，fault-tolerant">
<meta name="twitter:image" content="http://fanchao01.github.io/blog/blog/images/ha.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 一些容错方面的思考 | Blog My Minds </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?7f592ce66e56bd7572224ba7c19a8f40";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/blog/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Blog My Minds</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                一些容错方面的思考
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-01-15T00:00:00-08:00" content="2018-01-15">
              2018-01-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/blog/categories/系统与架构/" itemprop="url" rel="index">
                    <span itemprop="name">系统与架构</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/blog/2018/01/15/fault-tolerant/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/01/15/fault-tolerant/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h1><p>A fault-tolerant design enables a system to continue its intended operation, possibly at a reduced level, rather than failing completely, when some part of the system fails. If its operating quality decreases at all, the decrease is proportional to the severity of the failure, as compared to a naively designed system in which even a small failure can cause total breakdown.</p>
<p>维基百科上的容错有几方面意思：</p>
<ol>
<li>容错指系统遭遇故障时不是完全崩溃，而是能够降级提供服务；</li>
<li>容错系统的服务能力能够根据不同程度的故障保证不同程度的服务，优雅降级。</li>
</ol>
<h1 id="容错与高可用性"><a href="#容错与高可用性" class="headerlink" title="容错与高可用性"></a>容错与高可用性</h1><p>容错特指故障发生时的表现；而高可用性是指尽量规避影响用户的可能。可以将一个系统类比成汽车，容错是车祸时自动弹出的气囊，而高可用是刹车系统。我的理解是，容错是高可用性的一个子集，特指(预防)出现问题后的解决方案。</p>
<p>要想打造一个具有高度容错的系统，需要从架构设计、代码、运维、监控等多方面入手，以下介绍一些可以作为容错系统的思考切入点</p>
<h2 id="重试"><a href="#重试" class="headerlink" title="重试"></a>重试</h2><hr>
<p>重试是错误处理中最常使用的技术，通过重试能够大幅度提高SLA，提高系统的可用性。按照系统的状态，重试的难易程度不同。对于无状态服务，例如大多数HTTP请求，简单重新发起调用即可；但是对于有状态服务，不仅需要被请求方具有幂等性，而是要求整个系统具有幂等性。因为极有可能上次失败的调用，使整个下游的状态都发生了改变。因此，对于不同错误应采用不同的重试策略，一些错误不能重试。<br>另外，重试有副作用，可能引起大量的重复操作和吞吐。例如，一个页面展示显示不出来，用户会大量频繁点击，反而造成系统瞬时压力过大，给本来处于不正常的系统带来更加重的问题。按照具体策略不同，重试可能需要限制次数，或者根据成功率决定是否重试等。<br>重试的另外一个副作用是增大了延时，重试时间一般采用退化算法，失败次数越多，下次重试的等待时间越长，那么最大延时取决于最后一次重试成功时的总重试时间，这个时间一定要(远)小于整个系统的延时要求。</p>
<h2 id="超时"><a href="#超时" class="headerlink" title="超时"></a>超时</h2><hr>
<p>对各种请求，特别是跨模块/服务的请求一定要添加超时，无论是同步还是异步请求。超时除了能够保证延时，更大的作用在于能够快速发现问题，从而积极采取应对策略。假设一个系统出现内部问题，请求被开在某个状态无法返回，那么这个问题就很难处理，一方面监控发现需要一定时间，另一方面即使发现也很难处理，因为卡的状态可能是复杂且未知的。</p>
<h2 id="HA"><a href="#HA" class="headerlink" title="HA"></a>HA</h2><hr>
<p>这里的HA特指一些集群的方案和算法，保证单个服务或者单台机器出现问题而整个系统正常提供服务。简单来说就是避免单点问题。这个比较有名的总结即为下图。</p>
<p><img src="/blog/images/ha.png" alt="img"></p>
<p>通过改图可以总结出，就是简单的方案性能高，但是可用性较低；而复杂的方案，影响吞吐和延时。</p>
<p>从系统内部和外部可以将集群HA方案分为两个维度：</p>
<ol>
<li>集群本身支持HA，通过各种一致性算法保证强一致或者最终一致</li>
<li>集群外部，例如通过使用prox、LB等各种代理，但这要求服务最好无状态</li>
</ol>
<h2 id="服务分离"><a href="#服务分离" class="headerlink" title="服务分离"></a>服务分离</h2><hr>
<p>将重要服务/客户分离是减小问题的影响范围的最简易手段。现在比较流行微服务架构，不同的服务通过松耦合的方式连接，不同服务往往部署在不同的docker、虚拟机或者物理机上。根据服务的重要性不同，可以分离的程度不同。一些及其重要的服务，甚至单独部署在隔离的物理机上。</p>
<h2 id="服务冗余"><a href="#服务冗余" class="headerlink" title="服务冗余"></a>服务冗余</h2><hr>
<p>这里的服务冗余与HA不同，更加偏向于上图中的Backups。平时不提供服务，专门存在一个备份系统在主系统出现问题时进行快速切换。这里有两个问题，一个是数据的一致性问题，可以时时同步或者冷备份，但是一般都有一定时间内的数据丢失问题。而且在实际使用过程中，备份的系统往往有时候并不处在可用状态。主系统可能定时升级，而备份系统没有；同步到备份系统的数据可能某次有丢失不全等等。亚马逊也出现过类似问题，出现故障时恢复耗时过长，而主要原因就是备份系统起不来数据也不全。备份冗余的另外一个问题是快速切换，如果切换太慢那么可能还不如修复主系统。鉴于实际的种种问题，一般出现故障不太会倾向于切换到备系统，坑比较深。</p>
<h2 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h2><hr>
<p>当出现故障后，能够按照故障的严重程度不同，提供不同质量的服务。服务降级是容灾的核心，但是往往很难做到，这不仅需要好的架构设计，也需要好的编程实现。比较容易理解的例子是页面渲染，例如在页面不能加载一些宣传语广告时直接跳过，保证主要功能可用。另外通过将系统做到跨机器、跨机柜、跨TOR、跨机房、跨地域的容灾设计，可以保证不同程度的服务可用性。</p>
<h2 id="donwtime"><a href="#donwtime" class="headerlink" title="donwtime"></a>donwtime</h2><hr>
<p>对于各种可能出现的宕机，Oracle有一个概述，可以针对提到的这些点对当前系统进行重点排查。</p>
<h2 id="非计划宕机"><a href="#非计划宕机" class="headerlink" title="非计划宕机"></a>非计划宕机</h2><p><img src="/blog/images/unplanned_downtime.png" alt="img"></p>
<h2 id="有计划宕机"><a href="#有计划宕机" class="headerlink" title="有计划宕机"></a>有计划宕机</h2><p><img src="/blog/images/planned_downtime.png" alt="img"></p>
<p>处理针对这些点进行设计，更重要的是要有定期排查。现实是往往有一些容错、容灾、备份方案，但是一段时间没有用上后，这些手段就再也不演练。真的出现问题，这些手段已经跟当前系统不配置，失效了。</p>
<p>（完）</p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2017/09/28/cellv2-in-pike/" rel="next" title="OpenStack-Pike版本中的CellV2">
                <i class="fa fa-chevron-left"></i> OpenStack-Pike版本中的CellV2
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2018/01/15/fault-tolerant/"
           data-title="一些容错方面的思考" data-url="http://fanchao01.github.io/blog/blog/2018/01/15/fault-tolerant/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/blog/images/avatar.gif"
               alt="FanChao" />
          <p class="site-author-name" itemprop="name">FanChao</p>
          <p class="site-description motion-element" itemprop="description">Enjoin it!</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/blog/archives">
              <span class="site-state-item-count">39</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/blog/categories">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/blog/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#容错"><span class="nav-number">1.</span> <span class="nav-text">容错</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#容错与高可用性"><span class="nav-number">2.</span> <span class="nav-text">容错与高可用性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#重试"><span class="nav-number">2.1.</span> <span class="nav-text">重试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#超时"><span class="nav-number">2.2.</span> <span class="nav-text">超时</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HA"><span class="nav-number">2.3.</span> <span class="nav-text">HA</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务分离"><span class="nav-number">2.4.</span> <span class="nav-text">服务分离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务冗余"><span class="nav-number">2.5.</span> <span class="nav-text">服务冗余</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#服务降级"><span class="nav-number">2.6.</span> <span class="nav-text">服务降级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#donwtime"><span class="nav-number">2.7.</span> <span class="nav-text">donwtime</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#非计划宕机"><span class="nav-number">2.8.</span> <span class="nav-text">非计划宕机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#有计划宕机"><span class="nav-number">2.9.</span> <span class="nav-text">有计划宕机</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">FanChao</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"fanchao01"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
